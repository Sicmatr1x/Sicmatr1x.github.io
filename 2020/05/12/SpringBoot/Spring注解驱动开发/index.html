<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Spring注解驱动开发 | Sicmatr1x's Blog</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"键入以继续","blurHolder":"数据检索","noResult":"无 $0 相关数据"},"code":{"codeInfo":"$0 - 共 $1 行","copy":"复制","copyFinish":"复制成功","expand":"展开"}}</script><script src="/js/gitalk.js"></script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Sicmatr1x's Blog" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="数据检索" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li><li class="navItem"><a class="navBlock" href="/toolkit/"><span class="navItemTitle">Toolkit</span></a></li><li class="navItem"><a class="navBlock" href="/about/"><span class="navItemTitle">About</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Spring注解驱动开发</h1><div id="post-info"><span>文章发布时间: <div class="control"><time datetime="2020-05-12T08:02:27.000Z" id="date"> 2020-05-12</time></div></span><br><span>最后更新时间: <div class="control"><time datetime="2023-03-26T08:12:23.679Z" id="updated"> 2023-03-26</time></div></span></div></div><hr><div id="post-content"><h2 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h2><h3 id="组件注册"><a href="#组件注册" class="headerlink" title="组件注册"></a>组件注册</h3><h4 id="Configuration-amp-Bean-给容器中注册组件"><a href="#Configuration-amp-Bean-给容器中注册组件" class="headerlink" title="@Configuration &amp; @Bean 给容器中注册组件"></a><code>@Configuration</code> &amp; <code>@Bean</code> 给容器中注册组件</h4><p>配置类相当于以前的配置文件<code>beans.xml</code></p>
<p>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Person;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan.Filter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.FilterType;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><br><span class="hljs-meta">@Configuration</span> <span class="hljs-comment">// 告诉Spring这是一个配置类</span><br><span class="hljs-meta">@ComponentScan(value = &quot;com.sicmatr1x&quot;, excludeFilters = &#123;</span><br><span class="hljs-meta">        @Filter(type = FilterType.ANNOTATION, classes = &#123;Controller.class&#125;)</span><br><span class="hljs-meta">&#125;)</span> <span class="hljs-comment">// 手动配置包扫描，扫描com.sicmatr1x包下的内容，exclude可以排除不想注入的类，这里按照注解排除了使用到Controller注解的类</span><br><span class="hljs-comment">// @ComponentScan value:指定要扫描的包</span><br><span class="hljs-comment">// excludeFilters = Filter[] 指定扫描的时候按照什么规则排除哪些组件</span><br><span class="hljs-comment">// includeFilters = Filter[] 指定扫描的时候按照什么规则包含哪些组件</span><br><span class="hljs-comment">// useDefaultFilters = false 可以关闭默认的filter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig</span> &#123;<br>    <span class="hljs-meta">@Bean(&quot;person&quot;)</span> <span class="hljs-comment">// 给容器中注册一个bean，类型为返回值的类型，id默认为方法名，也可自定义</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Abby&quot;</span>, <span class="hljs-number">20</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.test;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Person;<br><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfig;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainTest</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">// 传统xml方式</span><br><span class="hljs-comment">//        ApplicationContext applicationContext = new ClassPathXmlApplicationContext(&quot;bean.xml&quot;);</span><br><span class="hljs-comment">//        Person bean = (Person) applicationContext.getBean(&quot;person&quot;);</span><br><span class="hljs-comment">//        System.out.println(bean);</span><br><br>        <span class="hljs-comment">// 以前传配置文件，现在传配置类</span><br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfig.class);<br>        <span class="hljs-type">Person</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> applicationContext.getBean(Person.class);<br>        System.out.println(bean);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="ComponentScan-自动扫描组件-amp-指定扫描规则"><a href="#ComponentScan-自动扫描组件-amp-指定扫描规则" class="headerlink" title="@ComponentScan 自动扫描组件&amp;指定扫描规则"></a><code>@ComponentScan</code> 自动扫描组件&amp;指定扫描规则</h4><p>查看IOT容器里面有哪些对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfig;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOCTest</span> &#123;<br><br>    <span class="hljs-meta">@SuppressWarnings(&quot;resource&quot;)</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">annotationConfigApplicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfig.class);<br>        String[] beanNames = annotationConfigApplicationContext.getBeanDefinitionNames();<br>        <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>            System.out.println(beanName);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">org.springframework.context.annotation.internalConfigurationAnnotationProcessor<br>org.springframework.context.annotation.internalAutowiredAnnotationProcessor<br>org.springframework.context.annotation.internalRequiredAnnotationProcessor<br>org.springframework.context.annotation.internalCommonAnnotationProcessor<br>org.springframework.context.event.internalEventListenerProcessor<br>org.springframework.context.event.internalEventListenerFactory<br>mainConfig<br>bookDao<br>bookService<br>person<br></code></pre></td></tr></table></figure>

<p>因为上面使用了<code>excludeFilters = &#123;@Filter(type = FilterType.ANNOTATION, classes = &#123;Controller.class&#125;</code>所以IOT容器中注入了除了<code>BookController</code>以外的其它位于包<code>com.sicmatr1x</code>下的类的对象</p>
<p>我们再看下其它的Filter，进入到<code>FilterType.class</code>里面</p>
<p>FilterType.java:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright 2002-2013 the original author or authors.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"> * you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"> * You may obtain a copy of the License at</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"> * See the License for the specific language governing permissions and</span><br><span class="hljs-comment"> * limitations under the License.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">package</span> org.springframework.context.annotation;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Enumeration of the type filters that may be used in conjunction with</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> ComponentScan <span class="hljs-doctag">@ComponentScan</span>&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mark Fisher</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Chris Beams</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2.5</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> ComponentScan</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> ComponentScan#includeFilters()</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> ComponentScan#excludeFilters()</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.core.type.filter.TypeFilter</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">FilterType</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Filter candidates marked with a given annotation.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.type.filter.AnnotationTypeFilter</span><br><span class="hljs-comment">	 */</span><br>	ANNOTATION,<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Filter candidates assignable to a given type.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.type.filter.AssignableTypeFilter</span><br><span class="hljs-comment">	 */</span><br>	ASSIGNABLE_TYPE,<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Filter candidates matching a given AspectJ type pattern expression.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.type.filter.AspectJTypeFilter</span><br><span class="hljs-comment">	 */</span><br>	ASPECTJ,<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Filter candidates matching a given regex pattern.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.type.filter.RegexPatternTypeFilter</span><br><span class="hljs-comment">	 */</span><br>	REGEX,<br><br>	<span class="hljs-comment">/** Filter candidates using a given custom</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.core.type.filter.TypeFilter&#125; implementation.</span><br><span class="hljs-comment">	 */</span><br>	CUSTOM<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<ul>
<li><code>ANNOTATION</code>: 按照注解来进行过滤<ul>
<li>eg: <code>@Filter(type = FilterType.ANNOTATION, classes = &#123;Controller.class&#125;</code></li>
</ul>
</li>
<li><code>ASSIGNABLE_TYPE</code>: 按照给定的类型来进行过滤<ul>
<li>eg: <code>@Filter(type = FilterType.ASSIGNABLE_TYPE, classes = &#123;BookController.class&#125;</code></li>
</ul>
</li>
<li><code>ASPECTJ</code>: 按照AspectJ表达式来进行过滤</li>
<li><code>REGEX</code>: 按照正则表达式来进行过滤</li>
<li><code>CUSTOM</code>: 按照自定义规则来进行过滤，需要自定义一个<code>org.springframework.core.type.filter.TypeFilter</code>的实现类</li>
</ul>
<h4 id="自定义TypeFilter指定过滤规则"><a href="#自定义TypeFilter指定过滤规则" class="headerlink" title="自定义TypeFilter指定过滤规则"></a>自定义TypeFilter指定过滤规则</h4><p>实现<code>org.springframework.core.type.filter.TypeFilter</code>类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> org.springframework.core.io.Resource;<br><span class="hljs-keyword">import</span> org.springframework.core.type.AnnotationMetadata;<br><span class="hljs-keyword">import</span> org.springframework.core.type.ClassMetadata;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.MetadataReader;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.MetadataReaderFactory;<br><span class="hljs-keyword">import</span> org.springframework.core.type.filter.TypeFilter;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTypeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeFilter</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metadataReader the metadata reader for the target class 读取到当前正在扫描的类的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metadataReaderFactory a factory for obtaining metadata readers 可以获取到其它任何类信息的</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true: 匹配成功; false: 匹配失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">match</span><span class="hljs-params">(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 获取当前类注解的信息</span><br>        <span class="hljs-type">AnnotationMetadata</span> <span class="hljs-variable">annotationMetadata</span> <span class="hljs-operator">=</span> metadataReader.getAnnotationMetadata();<br>        <span class="hljs-comment">// 获取当前正在扫描的类的类信息</span><br>        <span class="hljs-type">ClassMetadata</span> <span class="hljs-variable">classMetadata</span> <span class="hljs-operator">=</span> metadataReader.getClassMetadata();<br>        <span class="hljs-comment">// 获取当前类资源(类路径等)信息</span><br>        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> metadataReader.getResource();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> classMetadata.getClassName();<br>        System.out.println(<span class="hljs-string">&quot;className:&quot;</span> + className);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在Config类里面使用我们的Filter类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Person;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ComponentScan.Filter;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.FilterType;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(value = &quot;com.sicmatr1x&quot;, excludeFilters = &#123;</span><br><span class="hljs-meta">        @Filter(type = FilterType.CUSTOM, classes = &#123;MyTypeFilter.class&#125;)</span><br><span class="hljs-meta">&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig</span> &#123;<br>    <span class="hljs-meta">@Bean(&quot;person&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Abby&quot;</span>, <span class="hljs-number">20</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">className:com.sicmatr1x.bean.Person<br>className:com.sicmatr1x.config.MyTypeFilter<br>className:com.sicmatr1x.controller.BookController<br>className:com.sicmatr1x.dao.BookDao<br>className:com.sicmatr1x.service.BookService<br>className:com.sicmatr1x.test.MainTest<br>org.springframework.context.annotation.internalConfigurationAnnotationProcessor<br>org.springframework.context.annotation.internalAutowiredAnnotationProcessor<br>org.springframework.context.annotation.internalRequiredAnnotationProcessor<br>org.springframework.context.annotation.internalCommonAnnotationProcessor<br>org.springframework.context.event.internalEventListenerProcessor<br>org.springframework.context.event.internalEventListenerFactory<br>mainConfig<br>bookController<br>bookDao<br>bookService<br>person<br><br></code></pre></td></tr></table></figure>

<p>这里没有类被排除是因为我们的自定义规则里面总是返回false，所以一个都没有被排除</p>
<p>修改一下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> org.springframework.core.io.Resource;<br><span class="hljs-keyword">import</span> org.springframework.core.type.AnnotationMetadata;<br><span class="hljs-keyword">import</span> org.springframework.core.type.ClassMetadata;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.MetadataReader;<br><span class="hljs-keyword">import</span> org.springframework.core.type.classreading.MetadataReaderFactory;<br><span class="hljs-keyword">import</span> org.springframework.core.type.filter.TypeFilter;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTypeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">TypeFilter</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metadataReader the metadata reader for the target class 读取到当前正在扫描的类的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metadataReaderFactory a factory for obtaining metadata readers 可以获取到其它任何类信息的</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> true: 匹配成功; false: 匹配失败</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> IOException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">match</span><span class="hljs-params">(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-comment">// 获取当前类注解的信息</span><br>        <span class="hljs-type">AnnotationMetadata</span> <span class="hljs-variable">annotationMetadata</span> <span class="hljs-operator">=</span> metadataReader.getAnnotationMetadata();<br>        <span class="hljs-comment">// 获取当前正在扫描的类的类信息</span><br>        <span class="hljs-type">ClassMetadata</span> <span class="hljs-variable">classMetadata</span> <span class="hljs-operator">=</span> metadataReader.getClassMetadata();<br>        <span class="hljs-comment">// 获取当前类资源(类路径等)信息</span><br>        <span class="hljs-type">Resource</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> metadataReader.getResource();<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> classMetadata.getClassName();<br>        System.out.println(<span class="hljs-string">&quot;className:&quot;</span> + className);<br>        <span class="hljs-keyword">if</span>(className.contains(<span class="hljs-string">&quot;er&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">className:com.sicmatr1x.bean.Person<br>className:com.sicmatr1x.config.MyTypeFilter<br>className:com.sicmatr1x.controller.BookController<br>className:com.sicmatr1x.dao.BookDao<br>className:com.sicmatr1x.service.BookService<br>className:com.sicmatr1x.test.MainTest<br>org.springframework.context.annotation.internalConfigurationAnnotationProcessor<br>org.springframework.context.annotation.internalAutowiredAnnotationProcessor<br>org.springframework.context.annotation.internalRequiredAnnotationProcessor<br>org.springframework.context.annotation.internalCommonAnnotationProcessor<br>org.springframework.context.event.internalEventListenerProcessor<br>org.springframework.context.event.internalEventListenerFactory<br>mainConfig<br>bookDao<br>person<br></code></pre></td></tr></table></figure>

<p>与之前相比少了bookController, bookService，其实这里还排除了MyTypeFilter，不过这个类本来就用<code>annotationConfigApplicationContext.getBeanDefinitionNames()</code>获取不出来所以看不出效果</p>
<h4 id="Scope-设置组件作用域"><a href="#Scope-设置组件作用域" class="headerlink" title="@Scope 设置组件作用域"></a><code>@Scope</code> 设置组件作用域</h4><p>众所周知，在spring里面注册一个bean并托管到IOT容器中之后该bean是单实例的，无论你get几次都是获得的同一个对象</p>
<p>可以使用<code>@Scope</code>注解来限定对象范围</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Person;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Scope;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br>    <span class="hljs-meta">@Scope</span><br>    <span class="hljs-meta">@Bean(&quot;person&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">30</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>点进<code>@Scope</code>注解里面看一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright 2002-2015 the original author or authors.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"> * you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"> * You may obtain a copy of the License at</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"> * See the License for the specific language governing permissions and</span><br><span class="hljs-comment"> * limitations under the License.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">package</span> org.springframework.context.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Documented;<br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.config.ConfigurableBeanFactory;<br><span class="hljs-keyword">import</span> org.springframework.core.annotation.AliasFor;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * When used as a type-level annotation in conjunction with</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.stereotype.Component <span class="hljs-doctag">@Component</span>&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Scope</span>&#125; indicates the name of a scope to use for instances of</span><br><span class="hljs-comment"> * the annotated type.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;When used as a method-level annotation in conjunction with</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> Bean <span class="hljs-doctag">@Bean</span>&#125;, &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Scope</span>&#125; indicates the name of a scope to use</span><br><span class="hljs-comment"> * for the instance returned from the method.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;In this context, &lt;em&gt;scope&lt;/em&gt; means the lifecycle of an instance,</span><br><span class="hljs-comment"> * such as &#123;<span class="hljs-doctag">@code</span> singleton&#125;, &#123;<span class="hljs-doctag">@code</span> prototype&#125;, and so forth. Scopes</span><br><span class="hljs-comment"> * provided out of the box in Spring may be referred to using the</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> SCOPE_*&#125; constants available in the &#123;<span class="hljs-doctag">@link</span> ConfigurableBeanFactory&#125;</span><br><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@code</span> WebApplicationContext&#125; interfaces.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;To register additional custom scopes, see</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.config.CustomScopeConfigurer</span><br><span class="hljs-comment"> * CustomScopeConfigurer&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mark Fisher</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Chris Beams</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Sam Brannen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 2.5</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.stereotype.Component</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.annotation.Bean</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Scope &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Alias for &#123;<span class="hljs-doctag">@link</span> #scopeName&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #scopeName</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@AliasFor(&quot;scopeName&quot;)</span><br>	String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Specifies the name of the scope to use for the annotated component/bean.</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to an empty string (&#123;<span class="hljs-doctag">@code</span> &quot;&quot;&#125;) which implies</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> ConfigurableBeanFactory#SCOPE_SINGLETON SCOPE_SINGLETON&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 4.2</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> ConfigurableBeanFactory#SCOPE_PROTOTYPE</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> ConfigurableBeanFactory#SCOPE_SINGLETON</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.web.context.WebApplicationContext#SCOPE_REQUEST</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.web.context.WebApplicationContext#SCOPE_SESSION</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #value</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@AliasFor(&quot;value&quot;)</span><br>	String <span class="hljs-title function_">scopeName</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Specifies whether a component should be configured as a scoped proxy</span><br><span class="hljs-comment">	 * and if so, whether the proxy should be interface-based or subclass-based.</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to &#123;<span class="hljs-doctag">@link</span> ScopedProxyMode#DEFAULT&#125;, which typically indicates</span><br><span class="hljs-comment">	 * that no scoped proxy should be created unless a different default</span><br><span class="hljs-comment">	 * has been configured at the component-scan instruction level.</span><br><span class="hljs-comment">	 * &lt;p&gt;Analogous to &#123;<span class="hljs-doctag">@code</span> &lt;aop:scoped-proxy/&gt;&#125; support in Spring XML.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> ScopedProxyMode</span><br><span class="hljs-comment">	 */</span><br>	ScopedProxyMode <span class="hljs-title function_">proxyMode</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> ScopedProxyMode.DEFAULT;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这里的<code>@AliasFor</code>注解是别名的意思，就是给其注解的字段一个别名，比如这里<code>value</code>就和<code>scopeName</code>等价了</p>
<p>我们看下<code>value</code>能取哪些值，注释中就说了可以取以下类中的以下的值</p>
<p>类名#值：</p>
<ul>
<li>ConfigurableBeanFactory#SCOPE_PROTOTYPE</li>
<li>ConfigurableBeanFactory#SCOPE_SINGLETON</li>
<li>org.springframework.web.context.WebApplicationContext#SCOPE_REQUEST</li>
<li>org.springframework.web.context.WebApplicationContext#SCOPE_SESSION</li>
</ul>
<p>点进<code>ConfigurableBeanFactory</code>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ConfigurableBeanFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HierarchicalBeanFactory</span>, SingletonBeanRegistry &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">SCOPE_SINGLETON</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;singleton&quot;</span>;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">SCOPE_PROTOTYPE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;prototype&quot;</span>;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可知：<code>SCOPE_PROTOTYPE</code>的值为<code>prototype</code>，其它以此类推</p>
<p><code>value</code>能取：</p>
<ul>
<li><code>singleton</code>: 单实例（默认值），IOC容器启动时会调用方法创建对象并托管到IOC容器中，以后每次获取直接从容器中拿</li>
<li><code>prototype</code>: 多实例，IOC容器启动时并不会调用方法创建对象，而是每次获取的时候才会调用方法创建对象，每次获取都会调一遍方法</li>
<li><code>request</code>: 同一次请求创建一个实例</li>
<li><code>session</code>: 同一个session创建一个实例</li>
</ul>
<p>我们使用<code>prototype</code>试下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Person;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Scope;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br>    <span class="hljs-meta">@Scope(&quot;prototype&quot;)</span><br>    <span class="hljs-meta">@Bean(&quot;person&quot;)</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">30</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>测试方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;resource&quot;)</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">annotationConfigApplicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfig2.class);<br>    String[] beanNames = annotationConfigApplicationContext.getBeanDefinitionNames();<br>    <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>        System.out.println(beanName);<br>    &#125;<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> annotationConfigApplicationContext.getBean(<span class="hljs-string">&quot;person&quot;</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">bean2</span> <span class="hljs-operator">=</span> annotationConfigApplicationContext.getBean(<span class="hljs-string">&quot;person&quot;</span>);<br>    System.out.println(<span class="hljs-string">&quot;bean == bean2: &quot;</span> + (bean == bean2));<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">org.springframework.context.annotation.internalConfigurationAnnotationProcessor<br>org.springframework.context.annotation.internalAutowiredAnnotationProcessor<br>org.springframework.context.annotation.internalRequiredAnnotationProcessor<br>org.springframework.context.annotation.internalCommonAnnotationProcessor<br>org.springframework.context.event.internalEventListenerProcessor<br>org.springframework.context.event.internalEventListenerFactory<br>mainConfig2<br>person<br>bean == bean2: false<br><br></code></pre></td></tr></table></figure>

<p>可以看到已经不是单例了</p>
<h4 id="Lazy-bean-懒加载"><a href="#Lazy-bean-懒加载" class="headerlink" title="@Lazy-bean 懒加载"></a><code>@Lazy-bean</code> 懒加载</h4><p>懒加载主要针对单实例bean，单实例通常情况下IOC容器启动时会调用方法创建对象并托管到IOC容器中，以后每次获取直接从容器中拿。如果启用懒加载则会使得容器在启动时不创建对象，而是在第一次使用(获取)bean时创建对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Lazy</span><br><span class="hljs-meta">@Bean(&quot;person&quot;)</span><br><span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-number">30</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Conditional-按照条件注册bean"><a href="#Conditional-按照条件注册bean" class="headerlink" title="@Conditional 按照条件注册bean"></a><code>@Conditional</code> 按照条件注册bean</h4><p>该注解在spring底层大量使用，主要作用是按照一定的条件进行判断满足条件给容器中注册bean</p>
<p>那么该如何使用<code>@Conditional</code>注解呢，我们点进去看到需要提供一个实现了<code>Condition</code>接口的类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Documented;<br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Conditional &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * All &#123;<span class="hljs-doctag">@link</span> Condition&#125;s that must &#123;<span class="hljs-doctag">@linkplain</span> Condition#matches match&#125;</span><br><span class="hljs-comment">	 * in order for the component to be registered.</span><br><span class="hljs-comment">	 */</span><br>	Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Condition</span>&gt;[] value();<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</code>, 显然<code>@Conditional</code>注解可以用于方法和类</p>
<p>点进去看下<code>Condition</code>接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Condition</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Determine if the condition matches.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> context the condition context</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> metadata metadata of the &#123;<span class="hljs-doctag">@link</span> org.springframework.core.type.AnnotationMetadata class&#125;</span><br><span class="hljs-comment">	 * or &#123;<span class="hljs-doctag">@link</span> org.springframework.core.type.MethodMetadata method&#125; being checked.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> true&#125; if the condition matches and the component can be registered</span><br><span class="hljs-comment">	 * or &#123;<span class="hljs-doctag">@code</span> false&#125; to veto registration.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>显然需要实现<code>matches</code>方法，并且若返回为true则表示条件匹配成功</p>
<p>假设我们需要做一个根据操作系统来判断并注入对应的bean的功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.condition;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.config.ConfigurableListableBeanFactory;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistry;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Condition;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ConditionContext;<br><span class="hljs-keyword">import</span> org.springframework.core.env.Environment;<br><span class="hljs-keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LinuxCondition</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 判断是否为Linux系统</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> context 判断条件能使用的上下文环境</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> metadata 注解信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;<br>        <span class="hljs-comment">// 能获取到IOC使用的beanFactory</span><br>        <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> context.getBeanFactory();<br>        <span class="hljs-comment">// 能获取到类加载器</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> context.getClassLoader();<br>        <span class="hljs-comment">// 能获取到当前环境信息</span><br>        <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> context.getEnvironment();<br>        <span class="hljs-comment">// 能获取到bean定义的注册类(可用于查某个bean的定义或者注册bean)</span><br>        <span class="hljs-type">BeanDefinitionRegistry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> context.getRegistry();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> environment.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>        <span class="hljs-keyword">if</span>(property.contains(<span class="hljs-string">&quot;Linux&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.condition;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Condition;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ConditionContext;<br><span class="hljs-keyword">import</span> org.springframework.core.env.Environment;<br><span class="hljs-keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowsCondition</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Condition</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">matches</span><span class="hljs-params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> &#123;<br>        <span class="hljs-comment">// 能获取到当前环境信息</span><br>        <span class="hljs-type">Environment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> context.getEnvironment();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> environment.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>        <span class="hljs-keyword">if</span>(property.contains(<span class="hljs-string">&quot;Windows&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>然后使用<code>@Conditional</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Conditional(&#123;WindowsCondition.class&#125;)</span><br><span class="hljs-meta">@Bean(&quot;bill&quot;)</span><br><span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person01</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Bill&quot;</span>, <span class="hljs-number">60</span>);<br>&#125;<br><br><span class="hljs-meta">@Conditional(&#123;LinuxCondition.class&#125;)</span><br><span class="hljs-meta">@Bean(&quot;Linus&quot;)</span><br><span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person02</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">&quot;Linus&quot;</span>, <span class="hljs-number">50</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试一下效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings(&quot;resource&quot;)</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test03</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">annotationConfigApplicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfig2.class);<br>    <span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> annotationConfigApplicationContext.getEnvironment();<br>    <span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> environment.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>    System.out.println(property);<br>    String[] namesForType = annotationConfigApplicationContext.getBeanNamesForType(Person.class);<br>    <span class="hljs-keyword">for</span> (String name : namesForType) &#123;<br>        System.out.println(name);<br>    &#125;<br>    Map&lt;String, Person&gt; persons = annotationConfigApplicationContext.getBeansOfType(Person.class);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Windows 10<br>person<br>bill<br></code></pre></td></tr></table></figure>

<p>这里打印出了我们当前的操作系统为Windows 10，然后正确的注入了bill这个bean到IOT容器</p>
<p>测试Linux可以在VM arguments里面配置虚拟机参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">-Dos.name=Linux<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Linux<br>person<br>Linus<br></code></pre></td></tr></table></figure>

<p><code>@Conditional</code>注解还可以放在类上，作用是满足当前条件后这个类中配置的所有bean才能生效</p>
<h4 id="容器中注册组件方法"><a href="#容器中注册组件方法" class="headerlink" title="容器中注册组件方法"></a>容器中注册组件方法</h4><ol>
<li>包扫描+组件标注注解(<code>@Controller</code>, <code>@Service</code>, <code>@Component</code>)<ul>
<li>缺点：只能作用在自己写的类上，即需要修改需要注册的类的代码，导入的第三方包不可以采用此种方法</li>
</ul>
</li>
<li><code>@Bean</code>注解，手动注册</li>
<li><code>@Import</code>注解，快速导入组件到容器，id默认是全类名</li>
</ol>
<h4 id="Import-给容器中快速导入一个组件"><a href="#Import-给容器中快速导入一个组件" class="headerlink" title="@Import 给容器中快速导入一个组件"></a><code>@Import</code> 给容器中快速导入一个组件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Color;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.*;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(Color.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>批量导入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Color;<br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Red;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.*;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(&#123;Color.class, Red.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="Import-使用ImportSelector"><a href="#Import-使用ImportSelector" class="headerlink" title="@Import 使用ImportSelector"></a><code>@Import</code> 使用ImportSelector</h4><p>这种方法在spring源码用用到的较多</p>
<p>查看<code>@Import</code>的源码发现除了通常的组件类(regular component classes)作为参数传入以外还可以传入<code>Configuration</code>, <code>ImportSelector</code>, <code>ImportBeanDefinitionRegistrar</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Import &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> Configuration&#125;, &#123;<span class="hljs-doctag">@link</span> ImportSelector&#125;, &#123;<span class="hljs-doctag">@link</span> ImportBeanDefinitionRegistrar&#125;</span><br><span class="hljs-comment">	 * or regular component classes to import.</span><br><span class="hljs-comment">	 */</span><br>	Class&lt;?&gt;[] value();<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>查看<code>ImportSelector</code>源码: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Select and return the names of which class(es) should be imported based on</span><br><span class="hljs-comment">	 * the &#123;<span class="hljs-doctag">@link</span> AnnotationMetadata&#125; of the importing @&#123;<span class="hljs-doctag">@link</span> Configuration&#125; class.</span><br><span class="hljs-comment">	 */</span><br>	String[] selectImports(AnnotationMetadata importingClassMetadata);<br><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Select and return the names of which class(es) should be imported</p>
</blockquote>
<p>显然<code>selectImports</code>方法会返回需要导入的类的全类名组成的数组</p>
<p>在本项目中只有<code>MainConfig2</code>类里面使用到了<code>@Import</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(&#123;Color.class, MyImportSelector.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>我们打个断点到<code>selectImports</code>方法上看看传入的参数：</p>
<img src="./2020-05-26 11_41_57-spring-annotation – MainConfig2.java IntelliJ IDEA Administrator.png">

<p>可以看到<code>importingClassMetadata</code>对象包含的：</p>
<ul>
<li><code>annotations</code>对象数组里面获取到了<code>MainConfig2</code>类上面的2个注解</li>
<li><code>introspectedClass</code>对象则获取到了<code>MainConfig2</code>类的类信息</li>
</ul>
<p>继续debug就可发现：若返回为null则会抛出空指针异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Factory method to obtain &#123;<span class="hljs-doctag">@link</span> SourceClass&#125;s from class names.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">private</span> Collection&lt;SourceClass&gt; <span class="hljs-title function_">asSourceClasses</span><span class="hljs-params">(String[] classNames)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>	List&lt;SourceClass&gt; annotatedClasses = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;SourceClass&gt;(classNames.length); <span class="hljs-comment">// 这里调到了classNames.length，若返回为空，显然null没有length属性</span><br>	<span class="hljs-keyword">for</span> (String className : classNames) &#123;<br>		annotatedClasses.add(asSourceClass(className));<br>	&#125;<br>	<span class="hljs-keyword">return</span> annotatedClasses;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>推荐在没有class返回的情况下返回一个空数组</p>
<p>实践一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.condition;<br><br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ImportSelector;<br><span class="hljs-keyword">import</span> org.springframework.core.type.AnnotationMetadata;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyImportSelector</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportSelector</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> importingClassMetadata 当前标注<span class="hljs-doctag">@Import</span>注解的类的所有的类的信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回需要导入的类的全类名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;com.sicmatr1x.bean.Blue&quot;</span>, <span class="hljs-string">&quot;com.sicmatr1x.bean.Yellow&quot;</span>&#125;;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行unit test，可以看到已经注册进来了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mainConfig2<br>com.sicmatr1x.bean.Color<br>com.sicmatr1x.bean.Blue<br>com.sicmatr1x.bean.Yellow<br>person<br>bill<br></code></pre></td></tr></table></figure>

<h4 id="Import-使用ImportBeanDefinitionRegistrar"><a href="#Import-使用ImportBeanDefinitionRegistrar" class="headerlink" title="@Import 使用ImportBeanDefinitionRegistrar"></a><code>@Import</code> 使用ImportBeanDefinitionRegistrar</h4><p>从<code>@Import</code>源码里面继续点进去看<code>ImportBeanDefinitionRegistrar</code>的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Register bean definitions as necessary based on the given annotation metadata of</span><br><span class="hljs-comment">	 * the importing &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125; class.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that &#123;<span class="hljs-doctag">@link</span> BeanDefinitionRegistryPostProcessor&#125; types may &lt;em&gt;not&lt;/em&gt; be</span><br><span class="hljs-comment">	 * registered here, due to lifecycle constraints related to &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125;</span><br><span class="hljs-comment">	 * class processing.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> importingClassMetadata annotation metadata of the importing class</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> registry current bean definition registry</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(</span><br><span class="hljs-params">			AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>importingClassMetadata</code>: 当前类的一些注解信息</li>
<li><code>registry</code>: bean定义的注册类，可用于给程序中注册bean</li>
</ul>
<p>现在实现一下这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.condition;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.RainBow;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.support.BeanDefinitionRegistry;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.support.RootBeanDefinition;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.ImportBeanDefinitionRegistrar;<br><span class="hljs-keyword">import</span> org.springframework.core.type.AnnotationMetadata;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyImportBeanDefinitionRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 把所有需要添加到容器中的bean，可以通过BeanDefinition注册类的registerBeanDefinition方法注册进IOT容器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> importingClassMetadata 当前类的注解信息</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> registry BeanDefinition注册类，可用于给程序中注册bean</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br>        <span class="hljs-comment">// 判断IOT容器中是否已经注册了red和blue</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isRegisteredYellowClass</span> <span class="hljs-operator">=</span> registry.containsBeanDefinition(<span class="hljs-string">&quot;com.sicmatr1x.bean.Yellow&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isRegisteredBlueClass</span> <span class="hljs-operator">=</span> registry.containsBeanDefinition(<span class="hljs-string">&quot;com.sicmatr1x.bean.Blue&quot;</span>);<br>        <span class="hljs-keyword">if</span>(isRegisteredYellowClass &amp;&amp; isRegisteredBlueClass) &#123;<br>            <span class="hljs-comment">// 指定Bean定义信息(如Bean的类型、作用域等)</span><br>            <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(RainBow.class);<br>            <span class="hljs-comment">// 注册bean，同时指定bean名</span><br>            registry.registerBeanDefinition(<span class="hljs-string">&quot;rainBow&quot;</span>, beanDefinition);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>使用方法同前面的<code>MyImportSelector</code>类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(&#123;Color.class, MyImportSelector.class, MyImportBeanDefinitionRegistrar.class&#125;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行unit test：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mainConfig2<br>com.sicmatr1x.bean.Color<br>com.sicmatr1x.bean.Blue<br>com.sicmatr1x.bean.Yellow<br>person<br>bill<br>rainBow<br></code></pre></td></tr></table></figure>

<h4 id="使用FactoryBean注册组件"><a href="#使用FactoryBean注册组件" class="headerlink" title="使用FactoryBean注册组件"></a>使用FactoryBean注册组件</h4><p>使用前先看<code>FactoryBean</code>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">FactoryBean</span>&lt;T&gt; &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return an instance (possibly shared or independent) of the object</span><br><span class="hljs-comment">	 * managed by this factory.</span><br><span class="hljs-comment">	 * &lt;p&gt;As with a &#123;<span class="hljs-doctag">@link</span> BeanFactory&#125;, this allows support for both the</span><br><span class="hljs-comment">	 * Singleton and Prototype design pattern.</span><br><span class="hljs-comment">	 * &lt;p&gt;If this FactoryBean is not fully initialized yet at the time of</span><br><span class="hljs-comment">	 * the call (for example because it is involved in a circular reference),</span><br><span class="hljs-comment">	 * throw a corresponding &#123;<span class="hljs-doctag">@link</span> FactoryBeanNotInitializedException&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;As of Spring 2.0, FactoryBeans are allowed to return &#123;<span class="hljs-doctag">@code</span> null&#125;</span><br><span class="hljs-comment">	 * objects. The factory will consider this as normal value to be used; it</span><br><span class="hljs-comment">	 * will not throw a FactoryBeanNotInitializedException in this case anymore.</span><br><span class="hljs-comment">	 * FactoryBean implementations are encouraged to throw</span><br><span class="hljs-comment">	 * FactoryBeanNotInitializedException themselves now, as appropriate.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> an instance of the bean (can be &#123;<span class="hljs-doctag">@code</span> null&#125;)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception in case of creation errors</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> FactoryBeanNotInitializedException</span><br><span class="hljs-comment">	 */</span><br>	T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Return the type of object that this FactoryBean creates,</span><br><span class="hljs-comment">	 * or &#123;<span class="hljs-doctag">@code</span> null&#125; if not known in advance.</span><br><span class="hljs-comment">	 * &lt;p&gt;This allows one to check for specific types of beans without</span><br><span class="hljs-comment">	 * instantiating objects, for example on autowiring.</span><br><span class="hljs-comment">	 * &lt;p&gt;In the case of implementations that are creating a singleton object,</span><br><span class="hljs-comment">	 * this method should try to avoid singleton creation as far as possible;</span><br><span class="hljs-comment">	 * it should rather estimate the type in advance.</span><br><span class="hljs-comment">	 * For prototypes, returning a meaningful type here is advisable too.</span><br><span class="hljs-comment">	 * &lt;p&gt;This method can be called &lt;i&gt;before&lt;/i&gt; this FactoryBean has</span><br><span class="hljs-comment">	 * been fully initialized. It must not rely on state created during</span><br><span class="hljs-comment">	 * initialization; of course, it can still use such state if available.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Autowiring will simply ignore FactoryBeans that return</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> null&#125; here. Therefore it is highly recommended to implement</span><br><span class="hljs-comment">	 * this method properly, using the current state of the FactoryBean.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the type of object that this FactoryBean creates,</span><br><span class="hljs-comment">	 * or &#123;<span class="hljs-doctag">@code</span> null&#125; if not known at the time of the call</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> ListableBeanFactory#getBeansOfType</span><br><span class="hljs-comment">	 */</span><br>	Class&lt;?&gt; getObjectType();<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Is the object managed by this factory a singleton? That is,</span><br><span class="hljs-comment">	 * will &#123;<span class="hljs-doctag">@link</span> #getObject()&#125; always return the same object</span><br><span class="hljs-comment">	 * (a reference that can be cached)?</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; If a FactoryBean indicates to hold a singleton object,</span><br><span class="hljs-comment">	 * the object returned from &#123;<span class="hljs-doctag">@code</span> getObject()&#125; might get cached</span><br><span class="hljs-comment">	 * by the owning BeanFactory. Hence, do not return &#123;<span class="hljs-doctag">@code</span> true&#125;</span><br><span class="hljs-comment">	 * unless the FactoryBean always exposes the same reference.</span><br><span class="hljs-comment">	 * &lt;p&gt;The singleton status of the FactoryBean itself will generally</span><br><span class="hljs-comment">	 * be provided by the owning BeanFactory; usually, it has to be</span><br><span class="hljs-comment">	 * defined as singleton there.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; This method returning &#123;<span class="hljs-doctag">@code</span> false&#125; does not</span><br><span class="hljs-comment">	 * necessarily indicate that returned objects are independent instances.</span><br><span class="hljs-comment">	 * An implementation of the extended &#123;<span class="hljs-doctag">@link</span> SmartFactoryBean&#125; interface</span><br><span class="hljs-comment">	 * may explicitly indicate independent instances through its</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> SmartFactoryBean#isPrototype()&#125; method. Plain &#123;<span class="hljs-doctag">@link</span> FactoryBean&#125;</span><br><span class="hljs-comment">	 * implementations which do not implement this extended interface are</span><br><span class="hljs-comment">	 * simply assumed to always return independent instances if the</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> isSingleton()&#125; implementation returns &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> whether the exposed object is a singleton</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #getObject()</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> SmartFactoryBean#isPrototype()</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到有三个方法：</p>
<ol>
<li><code>T getObject() throws Exception</code>: 返回需要放到容器中的对象，这里是泛型也就是说工厂接口在实现时就已经确定了其只能返回某种类型的对象了</li>
<li><code>Class&lt;?&gt; getObjectType()</code>: 返回对象类型</li>
<li><code>boolean isSingleton();</code>: 是否为单例模式</li>
</ol>
<p>我们实现一下这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.FactoryBean;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 实现一个spring定义的工厂Bean</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ColorFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;Color&gt; &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> 返回Color对象，并添加到容器中</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> Exception</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Color <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;ColorFactoryBean:getObject()&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Color</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() &#123;<br>        <span class="hljs-keyword">return</span> Color.class;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * true表明为单例，容器中只保存一份</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>配置类里注册一下<code>ColorFactoryBean</code>工厂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfig2</span> &#123;<br>    <span class="hljs-comment">//...</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> ColorFactoryBean <span class="hljs-title function_">colorFactoryBean</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ColorFactoryBean</span>();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>unit test里从IOT容器中获取并打印一下我们的工厂的类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 工厂Bean获取的是调用getObject创建的对象</span><br><span class="hljs-type">Object</span> <span class="hljs-variable">factoryBean</span> <span class="hljs-operator">=</span> annotationConfigApplicationContext.getBean(<span class="hljs-string">&quot;colorFactoryBean&quot;</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">factoryBean2</span> <span class="hljs-operator">=</span> annotationConfigApplicationContext.getBean(<span class="hljs-string">&quot;colorFactoryBean&quot;</span>);<br>System.out.println(<span class="hljs-string">&quot;ColorFactoryBean class is &quot;</span> + factoryBean.getClass());<br>System.out.println(factoryBean == factoryBean2);<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">ColorFactoryBean:getObject()<br>ColorFactoryBean class is class com.sicmatr1x.bean.Color<br>true<br></code></pre></td></tr></table></figure>

<p>可以发现我们的工厂Bean的类型居然是<code>Color</code>，说明我们从IOT容器中getBean结果其实get到的是调用<code>ColorFactoryBean.getObject()</code>返回的对象，再用getBean获取一下发现两次获取到的对象是一样的，这表明我们重写<code>isSingleton()</code>方法的返回值被spring用于判断是否为单例模式了</p>
<p>如果想获取到<code>ColorFactoryBean</code>本身的话可以通过在bean的id前增加一个<code>&amp;</code>字符来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">factoryBean</span> <span class="hljs-operator">=</span> annotationConfigApplicationContext.getBean(<span class="hljs-string">&quot;&amp;colorFactoryBean&quot;</span>);<br></code></pre></td></tr></table></figure>

<p>至于为什么是这个字符，可以去<code>BeanFactory</code>接口里面定义了<code>&amp;</code>字符</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanFactory</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Used to dereference a &#123;<span class="hljs-doctag">@link</span> FactoryBean&#125; instance and distinguish it from</span><br><span class="hljs-comment">	 * beans &lt;i&gt;created&lt;/i&gt; by the FactoryBean. For example, if the bean named</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> myJndiObject&#125; is a FactoryBean, getting &#123;<span class="hljs-doctag">@code</span> &amp;myJndiObject&#125;</span><br><span class="hljs-comment">	 * will return the factory, not the instance returned by the factory.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">String</span> <span class="hljs-variable">FACTORY_BEAN_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&amp;&quot;</span>;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<hr>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><h4 id="Bean指定初始化和销毁方法"><a href="#Bean指定初始化和销毁方法" class="headerlink" title="@Bean指定初始化和销毁方法"></a><code>@Bean</code>指定初始化和销毁方法</h4><p>Bean的生命周期：</p>
<ul>
<li>bean创建</li>
<li>初始化</li>
<li>销毁</li>
</ul>
<p>Bean的生命周期现在是由容器来管理的，我们可以自定义初始化和销毁方法，容器在bean进行到当前生命周期的时候会调用我们自定义的初始化或销毁方法</p>
<p>以下会讲4种实现方式：</p>
<ol>
<li>指定初始化和销毁方法</li>
</ol>
<p>以前是在<code>beans.xml</code>文件中指定初始化和销毁方法<code>init-method=&quot;&quot; destroy-method=&quot;&quot;</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Car</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Car</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;Car:constructor&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Car:init()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Car:destroy()&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>现在可以通过<code>@Bean</code>注解配置对应的方法</p>
<ul>
<li>初始化：对象创建完成并赋值好，调用初始化方法</li>
<li>销毁：容器关闭的时候，进行销毁</li>
</ul>
<p>写一个配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.condition;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Car;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfigLifeCycle</span> &#123;<br><br>    <span class="hljs-meta">@Bean(initMethod = &quot;init&quot;, destroyMethod = &quot;destroy&quot;)</span><br>    <span class="hljs-keyword">public</span> Car <span class="hljs-title function_">car</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Car</span>();<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>unit test：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-comment">// 创建IOC容器</span><br>    <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">annotationConfigApplicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfigLifeCycle.class);<br>    System.out.println(<span class="hljs-string">&quot;容器创建完成&quot;</span>);<br>    annotationConfigApplicationContext.close();<br>    System.out.println(<span class="hljs-string">&quot;容器销毁完成&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Car:constructor<br>Car:init()<br>容器创建完成<br>Car:destroy()<br>容器销毁完成<br></code></pre></td></tr></table></figure>

<p>在单实例模式下对象的初始化在容器创建完之后进行，销毁在容器销毁前完成</p>
<p>在多实例模式下对象的初始化在你获取时进行，容器不会管理这个bean，容器不会调用其销毁方法</p>
<h4 id="InitializingBean-amp-DisposableBean"><a href="#InitializingBean-amp-DisposableBean" class="headerlink" title="InitializingBean &amp; DisposableBean"></a><code>InitializingBean</code> &amp; <code>DisposableBean</code></h4><ol start="2">
<li>实现<code>InitializingBean</code> &amp; <code>DisposableBean</code>接口</li>
</ol>
<p>用于在bean初始化时执行自定义初始化逻辑的接口</p>
<p>当<code>BeanFactory</code>创建好对象并且给bean里所有的属性设置完成后会调用<code>InitializingBean.afterPropertiesSet()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InitializingBean</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Invoked by a BeanFactory after it has set all bean properties supplied</span><br><span class="hljs-comment">	 * (and satisfied BeanFactoryAware and ApplicationContextAware).</span><br><span class="hljs-comment">	 * &lt;p&gt;This method allows the bean instance to perform initialization only</span><br><span class="hljs-comment">	 * possible when all bean properties have been set and to throw an</span><br><span class="hljs-comment">	 * exception in the event of misconfiguration.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception in the event of misconfiguration (such</span><br><span class="hljs-comment">	 * as failure to set an essential property) or if initialization fails.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>与之相对的在bean销毁时也有对应的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DisposableBean</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Invoked by a BeanFactory on destruction of a singleton.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> Exception in case of shutdown errors.</span><br><span class="hljs-comment">	 * Exceptions will get logged but not rethrown to allow</span><br><span class="hljs-comment">	 * other beans to release their resources too.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>给bean实现一下对应接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.DisposableBean;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.InitializingBean;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InitializingBean</span>, DisposableBean &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Cat</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Cat:constructor()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;Cat:destroy()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        System.out.println(<span class="hljs-string">&quot;Cat:afterPropertiesSet()&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行一下unit test：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Cat:constructor()<br>Cat:afterPropertiesSet()<br>Car:constructor<br>Car:init()<br>容器创建完成<br>Car:destroy()<br>Cat:destroy()<br>容器销毁完成<br></code></pre></td></tr></table></figure>

<h4 id="PostConstruct-amp-PreDestroy"><a href="#PostConstruct-amp-PreDestroy" class="headerlink" title="@PostConstruct &amp; @PreDestroy"></a><code>@PostConstruct</code> &amp; <code>@PreDestroy</code></h4><ol start="3">
<li>实现<code>@PostConstruct</code> &amp; <code>@PreDestroy</code>注解</li>
</ol>
<p><code>@PostConstruct</code> &amp; <code>@PreDestroy</code>注解在JSR250规范中被定义</p>
<p>话不多说，先看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> javax.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.annotation.ElementType.*;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.annotation.RetentionPolicy.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The PostConstruct annotation is used on a method that needs to be executed</span><br><span class="hljs-comment"> * after dependency injection is done to perform any initialization. This</span><br><span class="hljs-comment"> * method MUST be invoked before the class is put into service. This</span><br><span class="hljs-comment"> * annotation MUST be supported on all classes that support dependency</span><br><span class="hljs-comment"> * injection. The method annotated with PostConstruct MUST be invoked even</span><br><span class="hljs-comment"> * if the class does not request any resources to be injected. Only one</span><br><span class="hljs-comment"> * method can be annotated with this annotation. The method on which the</span><br><span class="hljs-comment"> * PostConstruct annotation is applied MUST fulfill all of the following</span><br><span class="hljs-comment"> * criteria:</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * &lt;ul&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method MUST NOT have any parameters except in the case of</span><br><span class="hljs-comment"> * interceptors in which case it takes an InvocationContext object as</span><br><span class="hljs-comment"> * defined by the Interceptors specification.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method defined on an interceptor class MUST HAVE one of the</span><br><span class="hljs-comment"> * following signatures:</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * void &amp;#060;METHOD&amp;#062;(InvocationContext)</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * Object &amp;#060;METHOD&amp;#062;(InvocationContext) throws Exception</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * &lt;i&gt;Note: A PostConstruct interceptor method must not throw application</span><br><span class="hljs-comment"> * exceptions, but it may be declared to throw checked exceptions including</span><br><span class="hljs-comment"> * the java.lang.Exception if the same interceptor method interposes on</span><br><span class="hljs-comment"> * business or timeout methods in addition to lifecycle events. If a</span><br><span class="hljs-comment"> * PostConstruct interceptor method returns a value, it is ignored by</span><br><span class="hljs-comment"> * the container.&lt;/i&gt;</span><br><span class="hljs-comment"> * &lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method defined on a non-interceptor class MUST HAVE the</span><br><span class="hljs-comment"> * following signature:</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * void &amp;#060;METHOD&amp;#062;()</span><br><span class="hljs-comment"> * &lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method on which PostConstruct is applied MAY be public, protected,</span><br><span class="hljs-comment"> * package private or private.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method MUST NOT be static except for the application client.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method MAY be final.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;If the method throws an unchecked exception the class MUST NOT be put into</span><br><span class="hljs-comment"> * service except in the case of EJBs where the EJB can handle exceptions and</span><br><span class="hljs-comment"> * even recover from them.&lt;/li&gt;&lt;/ul&gt;</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> Common Annotations 1.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> javax.annotation.PreDestroy</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> javax.annotation.Resource</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention</span> (RUNTIME)<br><span class="hljs-meta">@Target(METHOD)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> PostConstruct &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>The PostConstruct annotation is used on a method that needs to be executed after dependency injection is done to perform any initialization.</p>
</blockquote>
<p>显然这个注解的作用是用于在dependency injection(也就是bean创建完成且属性赋值完成)之后运行一个初始化方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> javax.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.*;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.annotation.ElementType.*;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> java.lang.annotation.RetentionPolicy.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * The PreDestroy annotation is used on methods as a callback notification to</span><br><span class="hljs-comment"> * signal that the instance is in the process of being removed by the</span><br><span class="hljs-comment"> * container. The method annotated with PreDestroy is typically used to</span><br><span class="hljs-comment"> * release resources that it has been holding. This annotation MUST be</span><br><span class="hljs-comment"> * supported by all container managed objects that support PostConstruct</span><br><span class="hljs-comment"> * except the application client container in Java EE 5. The method on which</span><br><span class="hljs-comment"> * the PreDestroy annotation is applied MUST fulfill all of the following</span><br><span class="hljs-comment"> * criteria:</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * &lt;ul&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method MUST NOT have any parameters except in the case of</span><br><span class="hljs-comment"> * interceptors in which case it takes an InvocationContext object as</span><br><span class="hljs-comment"> * defined by the Interceptors specification.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method defined on an interceptor class MUST HAVE one of the</span><br><span class="hljs-comment"> * following signatures:</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * void &amp;#060;METHOD&amp;#062;(InvocationContext)</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * Object &amp;#060;METHOD&amp;#062;(InvocationContext) throws Exception</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * &lt;i&gt;Note: A PreDestroy interceptor method must not throw application</span><br><span class="hljs-comment"> * exceptions, but it may be declared to throw checked exceptions including</span><br><span class="hljs-comment"> * the java.lang.Exception if the same interceptor method interposes on</span><br><span class="hljs-comment"> * business or timeout methods in addition to lifecycle events. If a</span><br><span class="hljs-comment"> * PreDestroy interceptor method returns a value, it is ignored by</span><br><span class="hljs-comment"> * the container.&lt;/i&gt;</span><br><span class="hljs-comment"> * &lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method defined on a non-interceptor class MUST HAVE the</span><br><span class="hljs-comment"> * following signature:</span><br><span class="hljs-comment"> * &lt;p&gt;</span><br><span class="hljs-comment"> * void &amp;#060;METHOD&amp;#062;()</span><br><span class="hljs-comment"> * &lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method on which PreDestroy is applied MAY be public, protected,</span><br><span class="hljs-comment"> * package private or private.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method MUST NOT be static.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;The method MAY be final.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;li&gt;If the method throws an unchecked exception it is ignored except in the</span><br><span class="hljs-comment"> * case of EJBs where the EJB can handle exceptions.&lt;/li&gt;</span><br><span class="hljs-comment"> * &lt;/ul&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> javax.annotation.PostConstruct</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> javax.annotation.Resource</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> Common Annotations 1.0</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Retention</span> (RUNTIME)<br><span class="hljs-meta">@Target(METHOD)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> PreDestroy &#123;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<blockquote>
<p>The PreDestroy annotation is used on methods as a callback notification to signal that the instance is in the process of being removed by the container.</p>
</blockquote>
<p>显然被注解方法会在 being removed by the container之前做为callback notification to signal被调用，即容器销毁bean之前调用该方法</p>
<p>创建一个bean来试验一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> javax.annotation.PreDestroy;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Dog:constructor()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 对象创建并赋值之后调用</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Dog:init() by @PostConstruct&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 容器移除对象之前调用</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PreDestroy</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Dog:destroy() by @PreDestroy&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>run unit test看一下输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Cat:constructor()<br>Cat:afterPropertiesSet()<br>Dog:constructor()<br>Dog:init() by @PostConstruct<br>Car:constructor<br>Car:init()<br>容器创建完成<br>Car:destroy()<br>Dog:destroy() by @PreDestroy<br>Cat:destroy()<br>容器销毁完成<br></code></pre></td></tr></table></figure>

<h4 id="BeanPostProcessor-bean的后置处理器"><a href="#BeanPostProcessor-bean的后置处理器" class="headerlink" title="BeanPostProcessor bean的后置处理器"></a><code>BeanPostProcessor</code> bean的后置处理器</h4><ol start="4">
<li><code>BeanPostProcessor</code> bean的后置处理器</li>
</ol>
<p>在bean初始化前后进行处理</p>
<p>按照惯例，看源码先：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Apply this BeanPostProcessor to the given new bean instance &lt;i&gt;before&lt;/i&gt; any bean</span><br><span class="hljs-comment">	 * initialization callbacks (like InitializingBean&#x27;s &#123;<span class="hljs-doctag">@code</span> afterPropertiesSet&#125;</span><br><span class="hljs-comment">	 * or a custom init-method). The bean will already be populated with property values.</span><br><span class="hljs-comment">	 * The returned bean instance may be a wrapper around the original.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> bean the new bean instance</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> beanName the name of the bean</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the bean instance to use, either the original or a wrapped one;</span><br><span class="hljs-comment">	 * if &#123;<span class="hljs-doctag">@code</span> null&#125;, no subsequent BeanPostProcessors will be invoked</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.beans.factory.InitializingBean#afterPropertiesSet</span><br><span class="hljs-comment">	 */</span><br>	Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Apply this BeanPostProcessor to the given new bean instance &lt;i&gt;after&lt;/i&gt; any bean</span><br><span class="hljs-comment">	 * initialization callbacks (like InitializingBean&#x27;s &#123;<span class="hljs-doctag">@code</span> afterPropertiesSet&#125;</span><br><span class="hljs-comment">	 * or a custom init-method). The bean will already be populated with property values.</span><br><span class="hljs-comment">	 * The returned bean instance may be a wrapper around the original.</span><br><span class="hljs-comment">	 * &lt;p&gt;In case of a FactoryBean, this callback will be invoked for both the FactoryBean</span><br><span class="hljs-comment">	 * instance and the objects created by the FactoryBean (as of Spring 2.0). The</span><br><span class="hljs-comment">	 * post-processor can decide whether to apply to either the FactoryBean or created</span><br><span class="hljs-comment">	 * objects or both through corresponding &#123;<span class="hljs-doctag">@code</span> bean instanceof FactoryBean&#125; checks.</span><br><span class="hljs-comment">	 * &lt;p&gt;This callback will also be invoked after a short-circuiting triggered by a</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation&#125; method,</span><br><span class="hljs-comment">	 * in contrast to all other BeanPostProcessor callbacks.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> bean the new bean instance</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@param</span> beanName the name of the bean</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the bean instance to use, either the original or a wrapped one;</span><br><span class="hljs-comment">	 * if &#123;<span class="hljs-doctag">@code</span> null&#125;, no subsequent BeanPostProcessors will be invoked</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.beans.factory.InitializingBean#afterPropertiesSet</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.beans.factory.FactoryBean</span><br><span class="hljs-comment">	 */</span><br>	Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Apply this BeanPostProcessor to the given new bean instance before any bean initialization callbacks.</p>
</blockquote>
<p>运行这个BeanPostProcessor在一个新的bean的实例调用任何initialization callbacks之前，也就是说会在一个bean的实例初始化时的所有的初始化调用方法之前调用该方法，相当于最早调用的bean的实例的初始化方法</p>
<ul>
<li><code>postProcessBeforeInitialization</code>: 在任何初始化方法之前进行处理工作</li>
<li><code>postProcessAfterInitialization</code>: 在任何初始化方法之后进行处理工作</li>
</ul>
<blockquote>
<p>@return the bean instance to use, either the original or a wrapped one;</p>
</blockquote>
<p>你可以返回一个原本的bean(通过参数传进来的)，也可以包装一下再返回</p>
<p>我们实现一下这个接口来做一个自己的BeanPostProcessor：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 后置处理器，初始化前后进行处理</span><br><span class="hljs-comment"> * 讲后置处理器假如到容器</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;MyBeanPostProcessor:postProcessBeforeInitialization():bean=&quot;</span> + bean + <span class="hljs-string">&quot;, beanName=&quot;</span> + beanName);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;MyBeanPostProcessor:postProcessAfterInitialization():bean=&quot;</span> + bean + <span class="hljs-string">&quot;, beanName=&quot;</span> + beanName);<br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行一下unit test：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">MyBeanPostProcessor:postProcessBeforeInitialization():bean=org.springframework.context.event.EventListenerMethodProcessor@c8e4bb0, beanName=org.springframework.context.event.internalEventListenerProcessor<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=org.springframework.context.event.EventListenerMethodProcessor@c8e4bb0, beanName=org.springframework.context.event.internalEventListenerProcessor<br>MyBeanPostProcessor:postProcessBeforeInitialization():bean=org.springframework.context.event.DefaultEventListenerFactory@4206a205, beanName=org.springframework.context.event.internalEventListenerFactory<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=org.springframework.context.event.DefaultEventListenerFactory@4206a205, beanName=org.springframework.context.event.internalEventListenerFactory<br>MyBeanPostProcessor:postProcessBeforeInitialization():bean=com.sicmatr1x.condition.MainConfigLifeCycle$$EnhancerBySpringCGLIB$$883e25cf@57175e74, beanName=mainConfigLifeCycle<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=com.sicmatr1x.condition.MainConfigLifeCycle$$EnhancerBySpringCGLIB$$883e25cf@57175e74, beanName=mainConfigLifeCycle<br>Cat:constructor()<br>MyBeanPostProcessor:postProcessBeforeInitialization():bean=com.sicmatr1x.bean.Cat@770c2e6b, beanName=cat<br>Cat:afterPropertiesSet()<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=com.sicmatr1x.bean.Cat@770c2e6b, beanName=cat<br>Dog:constructor()<br>MyBeanPostProcessor:postProcessBeforeInitialization():bean=com.sicmatr1x.bean.Dog@1a38c59b, beanName=dog<br>Dog:init() by @PostConstruct<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=com.sicmatr1x.bean.Dog@1a38c59b, beanName=dog<br>Car:constructor<br>MyBeanPostProcessor:postProcessBeforeInitialization():bean=com.sicmatr1x.bean.Car@105fece7, beanName=car<br>Car:init()<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=com.sicmatr1x.bean.Car@105fece7, beanName=car<br>容器创建完成<br>Car:destroy()<br>Dog:destroy() by @PreDestroy<br>Cat:destroy()<br>容器销毁完成<br><br></code></pre></td></tr></table></figure>

<p>可以看到我们之前的<code>Cat</code>, <code>Dog</code>类的init方法被夹在<code>MyBeanPostProcessor</code>的两个方法之间运行了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">MyBeanPostProcessor:postProcessBeforeInitialization():bean=com.sicmatr1x.bean.Cat@770c2e6b, beanName=cat<br>Cat:afterPropertiesSet()<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=com.sicmatr1x.bean.Cat@770c2e6b, beanName=cat<br></code></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">MyBeanPostProcessor:postProcessBeforeInitialization():bean=com.sicmatr1x.bean.Dog@1a38c59b, beanName=dog<br>Dog:init() by @PostConstruct<br>MyBeanPostProcessor:postProcessAfterInitialization():bean=com.sicmatr1x.bean.Dog@1a38c59b, beanName=dog<br></code></pre></td></tr></table></figure>

<p>再看<code>BeanPostProcessor</code>的注释，里面举例子提到了<code>afterPropertiesSet</code>和<code>custom init-method</code>就正好对应我们的<code>Cat.afterPropertiesSet()</code>和<code>Car.init()</code></p>
<blockquote>
<p>Apply this BeanPostProcessor to the given new bean instance before any bean initialization callbacks (like InitializingBean’s {@code afterPropertiesSet} or a custom init-method)</p>
</blockquote>
<h4 id="BeanPostProcessor-原理"><a href="#BeanPostProcessor-原理" class="headerlink" title="BeanPostProcessor 原理"></a><code>BeanPostProcessor</code> 原理</h4><p>我们还是用上个例子来看，在<code>MyBeanPostProcessor.postProcessBeforeInitialization</code>方法里面打个断点</p>
<img src="./idea-debug-MyBeanPostProcessor.postProcessBeforeInitialization.png">

<p>看一下上图的方法调用栈，我们从创建IOC容器开始按照上面那个调用栈一个一个往上看：</p>
<p>用<code>// &lt;=========</code>来表明断点的位置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOCTest_LifeCycle</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 创建IOC容器</span><br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">annotationConfigApplicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfigLifeCycle.class);<span class="hljs-comment">// &lt;=========</span><br>        System.out.println(<span class="hljs-string">&quot;容器创建完成&quot;</span>);<br>        annotationConfigApplicationContext.close();<br>        System.out.println(<span class="hljs-string">&quot;容器销毁完成&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用<code>AnnotationConfigApplicationContext</code>构造方法创建IOC容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationConfigApplicationContext</span><span class="hljs-params">(Class&lt;?&gt;... annotatedClasses)</span> &#123;<br>	<span class="hljs-built_in">this</span>();<br>	register(annotatedClasses);<br>	refresh();<span class="hljs-comment">// &lt;=========</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>AnnotationConfigApplicationContext</code>构造方法调用了<code>refresh()</code>方法来刷新容器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>finishBeanFactoryInitialization(beanFactory);<span class="hljs-comment">// &lt;=========</span><br></code></pre></td></tr></table></figure>

<p>显然从注释可以看出<code>refresh()</code>方法里面调用了<code>finishBeanFactoryInitialization</code>来初始化所有的单例对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span><br>beanFactory.preInstantiateSingletons();<span class="hljs-comment">// &lt;=========</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Trigger initialization of all non-lazy singleton beans...</span><br><span class="hljs-keyword">for</span> (String beanName : beanNames) &#123; <span class="hljs-comment">// 这个beanNames数组里面装的就是我们之前所有的bean id，比如car, cat, dog</span><br>	<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);<br>	<span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;<br>		<span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;<br>			<span class="hljs-keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) getBean(FACTORY_BEAN_PREFIX + beanName);<br>			<span class="hljs-type">boolean</span> isEagerInit;<br>			<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;<br>				isEagerInit = AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Boolean&gt;() &#123;<br>					<span class="hljs-meta">@Override</span><br>					<span class="hljs-keyword">public</span> Boolean <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>						<span class="hljs-keyword">return</span> ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit();<br>					&#125;<br>				&#125;, getAccessControlContext());<br>			&#125;<br>			<span class="hljs-keyword">else</span> &#123;<br>				isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp;<br>						((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());<br>			&#125;<br>			<span class="hljs-keyword">if</span> (isEagerInit) &#123;<br>				getBean(beanName);<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			getBean(beanName);<span class="hljs-comment">// &lt;=========</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>初始化所有的非懒加载的单例bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>	<span class="hljs-keyword">return</span> doGetBean(name, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);<span class="hljs-comment">// &lt;=========</span><br>&#125;<br></code></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Create bean instance.</span><br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>	sharedInstance = getSingleton(beanName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectFactory</span>&lt;Object&gt;() &#123;<span class="hljs-comment">// &lt;=========</span><br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<br>			&#125;<br>			<span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>				<span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br>				<span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br>				<span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>				destroySingleton(beanName);<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>		&#125;<br>	&#125;);<br>	bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用<code>getSingleton</code>获取单实例，若获取不到则会调用<code>createBean</code>创建对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>	singletonObject = singletonFactory.getObject();<span class="hljs-comment">// &lt;=========</span><br>	newSingleton = <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Create bean instance.</span><br><span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;<br>	sharedInstance = getSingleton(beanName, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectFactory</span>&lt;Object&gt;() &#123;<br>		<span class="hljs-meta">@Override</span><br>		<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>			<span class="hljs-keyword">try</span> &#123;<br>				<span class="hljs-keyword">return</span> createBean(beanName, mbd, args);<span class="hljs-comment">// &lt;=========</span><br>			&#125;<br>			<span class="hljs-keyword">catch</span> (BeansException ex) &#123;<br>				<span class="hljs-comment">// Explicitly remove instance from singleton cache: It might have been put there</span><br>				<span class="hljs-comment">// eagerly by the creation process, to allow for circular reference resolution.</span><br>				<span class="hljs-comment">// Also remove any beans that received a temporary reference to the bean.</span><br>				destroySingleton(beanName);<br>				<span class="hljs-keyword">throw</span> ex;<br>			&#125;<br>		&#125;<br>	&#125;);<br></code></pre></td></tr></table></figure>

<p>调用<code>createBean</code>创建对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> doCreateBean(beanName, mbdToUse, args);<span class="hljs-comment">// &lt;=========</span><br><span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;<br>	logger.debug(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>createBean</code>方法调完就会创建出来实例，<code>beanInstance</code>就是创建出来的实例，进去看下怎么创建的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;<br>	populateBean(beanName, mbd, instanceWrapper); <span class="hljs-comment">// 为bean的属性赋值</span><br>	<span class="hljs-keyword">if</span> (exposedObject != <span class="hljs-literal">null</span>) &#123;<br>		exposedObject = initializeBean(beanName, exposedObject, mbd);<span class="hljs-comment">// &lt;=========</span><br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里调了一个叫<code>initializeBean</code>的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Initialize the given bean instance, applying factory callbacks</span><br><span class="hljs-comment"> * as well as init methods and bean post processors.</span><br><span class="hljs-comment"> * &lt;p&gt;Called from &#123;<span class="hljs-doctag">@link</span> #createBean&#125; for traditionally defined beans,</span><br><span class="hljs-comment"> * and from &#123;<span class="hljs-doctag">@link</span> #initializeBean&#125; for existing bean instances.</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> beanName the bean name in the factory (for debugging purposes)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> bean the new bean instance we may need to initialize</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> mbd the bean definition that the bean was created with</span><br><span class="hljs-comment"> * (can also be &#123;<span class="hljs-doctag">@code</span> null&#125;, if given an existing bean instance)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the initialized bean instance (potentially wrapped)</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BeanNameAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BeanClassLoaderAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> BeanFactoryAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #applyBeanPostProcessorsBeforeInitialization</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #invokeInitMethods</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> #applyBeanPostProcessorsAfterInitialization</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">initializeBean</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String beanName, <span class="hljs-keyword">final</span> Object bean, RootBeanDefinition mbd)</span> &#123;<br>	<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span>) &#123;<br>		AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>				invokeAwareMethods(beanName, bean);<br>				<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>			&#125;<br>		&#125;, getAccessControlContext());<br>	&#125;<br>	<span class="hljs-keyword">else</span> &#123;<br>		invokeAwareMethods(beanName, bean);<br>	&#125;<br><br>	<span class="hljs-type">Object</span> <span class="hljs-variable">wrappedBean</span> <span class="hljs-operator">=</span> bean;<br>	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>		wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);<span class="hljs-comment">// &lt;=========</span><br>	&#125;<br><br>	<span class="hljs-keyword">try</span> &#123;<br>		invokeInitMethods(beanName, wrappedBean, mbd); <span class="hljs-comment">// 执行初始化方法</span><br>	&#125;<br>	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(<br>				(mbd != <span class="hljs-literal">null</span> ? mbd.getResourceDescription() : <span class="hljs-literal">null</span>),<br>				beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex);<br>	&#125;<br><br>	<span class="hljs-keyword">if</span> (mbd == <span class="hljs-literal">null</span> || !mbd.isSynthetic()) &#123;<br>		wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);<br>	&#125;<br>	<span class="hljs-keyword">return</span> wrappedBean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>看到这里的<code>applyBeanPostProcessorsBeforeInitialization</code>熟悉不，长的像啥，就是在<code>initializeBean</code>的方法里面调到了我们定义的处理器<code>MyBeanPostProcessor</code>，<br>可知是先为bean的属性赋值之后再调的处理器</p>
<p>看到了没有，断点在<code>invokeInitMethods(beanName, wrappedBean, mbd);</code>这句话上面，表明先执行我们之前实现的<code>postProcessBeforeInitialization</code>方法里面的内容再来运行之前提到的那些初始化bean的方法</p>
<p>再往下看，<code>applyBeanPostProcessorsAfterInitialization</code>眼熟不，长的像啥，表明先执行之前提到的那些初始化bean的方法之后再来运行我们之前实现的<code>postProcessAfterInitialization</code>方法里面的内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">applyBeanPostProcessorsBeforeInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span><br>		<span class="hljs-keyword">throws</span> BeansException &#123;<br><br>	<span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> existingBean;<br>	<span class="hljs-keyword">for</span> (BeanPostProcessor beanProcessor : getBeanPostProcessors()) &#123;<br>		result = beanProcessor.postProcessBeforeInitialization(result, beanName);<span class="hljs-comment">// &lt;=========</span><br>		<span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-keyword">return</span> result;<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里逐个遍历了<code>BeanPostProcessor</code>，当前断点里面的这个<code>beanProcessor</code>变量里面的值就是我们之前定义的<code>MyBeanPostProcessor</code>类的对象。这里调用到了<code>postProcessBeforeInitialization</code>方法就是我们实现的那个。</p>
<p>我们还知道了一旦我们实现的<code>postProcessBeforeInitialization</code>方法返回null之后，整个BeanPostProcessor就不会执行后面的其它的beanProcessor了，跳出for循环，直接就返回了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;MyBeanPostProcessor:postProcessBeforeInitialization():bean=&quot;</span> + bean + <span class="hljs-string">&quot;, beanName=&quot;</span> + beanName);<span class="hljs-comment">// &lt;=========</span><br>        <span class="hljs-keyword">return</span> bean;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>最后就进到我打断点的地方了</p>
<h4 id="BeanPostProcessor在Spring底层的使用"><a href="#BeanPostProcessor在Spring底层的使用" class="headerlink" title="BeanPostProcessor在Spring底层的使用"></a><code>BeanPostProcessor</code>在Spring底层的使用</h4><ul>
<li><code>ApplicationContextAwareProcessor</code>: 组件里面注入IOC容器</li>
</ul>
<p>实现一下这个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-keyword">import</span> javax.annotation.PostConstruct;<br><span class="hljs-keyword">import</span> javax.annotation.PreDestroy;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span> &#123;<br><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Dog</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Dog:constructor()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 对象创建并赋值之后调用</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Dog:init() by @PostConstruct&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 容器移除对象之前调用</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@PreDestroy</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Dog:destroy() by @PreDestroy&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        <span class="hljs-built_in">this</span>.applicationContext = applicationContext;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在Dog这个类里面，重写了<code>setApplicationContext</code>这个方法，我们可以在这个方法里面把获取到的IOC容器对象applicationContext赋值给我们的私有属性，然后就可以在其它需要用到的方法里面调到了</p>
<p>那么它是如何实现这个功能的呢？上源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.support;<br><br><span class="hljs-keyword">import</span> java.security.AccessControlContext;<br><span class="hljs-keyword">import</span> java.security.AccessController;<br><span class="hljs-keyword">import</span> java.security.PrivilegedAction;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.Aware;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.config.BeanPostProcessor;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.config.EmbeddedValueResolver;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationEventPublisherAware;<br><span class="hljs-keyword">import</span> org.springframework.context.ConfigurableApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.EmbeddedValueResolverAware;<br><span class="hljs-keyword">import</span> org.springframework.context.EnvironmentAware;<br><span class="hljs-keyword">import</span> org.springframework.context.MessageSourceAware;<br><span class="hljs-keyword">import</span> org.springframework.context.ResourceLoaderAware;<br><span class="hljs-keyword">import</span> org.springframework.util.StringValueResolver;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.config.BeanPostProcessor&#125;</span><br><span class="hljs-comment"> * implementation that passes the ApplicationContext to beans that</span><br><span class="hljs-comment"> * implement the &#123;<span class="hljs-doctag">@link</span> EnvironmentAware&#125;, &#123;<span class="hljs-doctag">@link</span> EmbeddedValueResolverAware&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> ResourceLoaderAware&#125;, &#123;<span class="hljs-doctag">@link</span> ApplicationEventPublisherAware&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> MessageSourceAware&#125; and/or &#123;<span class="hljs-doctag">@link</span> ApplicationContextAware&#125; interfaces.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Implemented interfaces are satisfied in order of their mention above.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Application contexts will automatically register this with their</span><br><span class="hljs-comment"> * underlying bean factory. Applications do not use this directly.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Costin Leau</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Chris Beams</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 10.10.2003</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.EnvironmentAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.EmbeddedValueResolverAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.ResourceLoaderAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.ApplicationEventPublisherAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.MessageSourceAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.ApplicationContextAware</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.context.support.AbstractApplicationContext#refresh()</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ApplicationContextAwareProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BeanPostProcessor</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConfigurableApplicationContext applicationContext;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringValueResolver embeddedValueResolver;<br><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create a new ApplicationContextAwareProcessor for the given context.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-title function_">ApplicationContextAwareProcessor</span><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span> &#123;<br>		<span class="hljs-built_in">this</span>.applicationContext = applicationContext;<br>		<span class="hljs-built_in">this</span>.embeddedValueResolver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddedValueResolver</span>(applicationContext.getBeanFactory());<br>	&#125;<br><br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(<span class="hljs-keyword">final</span> Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>		<span class="hljs-type">AccessControlContext</span> <span class="hljs-variable">acc</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>		<span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp;<br>				(bean <span class="hljs-keyword">instanceof</span> EnvironmentAware || bean <span class="hljs-keyword">instanceof</span> EmbeddedValueResolverAware ||<br>						bean <span class="hljs-keyword">instanceof</span> ResourceLoaderAware || bean <span class="hljs-keyword">instanceof</span> ApplicationEventPublisherAware ||<br>						bean <span class="hljs-keyword">instanceof</span> MessageSourceAware || bean <span class="hljs-keyword">instanceof</span> ApplicationContextAware)) &#123;<br>			acc = <span class="hljs-built_in">this</span>.applicationContext.getBeanFactory().getAccessControlContext();<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (acc != <span class="hljs-literal">null</span>) &#123;<br>			AccessController.doPrivileged(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;<br>				<span class="hljs-meta">@Override</span><br>				<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>					invokeAwareInterfaces(bean);<br>					<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>				&#125;<br>			&#125;, acc);<br>		&#125;<br>		<span class="hljs-keyword">else</span> &#123;<br>			invokeAwareInterfaces(bean);<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeAwareInterfaces</span><span class="hljs-params">(Object bean)</span> &#123;<br>		<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Aware) &#123;<br>			<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> EnvironmentAware) &#123;<br>				((EnvironmentAware) bean).setEnvironment(<span class="hljs-built_in">this</span>.applicationContext.getEnvironment());<br>			&#125;<br>			<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> EmbeddedValueResolverAware) &#123;<br>				((EmbeddedValueResolverAware) bean).setEmbeddedValueResolver(<span class="hljs-built_in">this</span>.embeddedValueResolver);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ResourceLoaderAware) &#123;<br>				((ResourceLoaderAware) bean).setResourceLoader(<span class="hljs-built_in">this</span>.applicationContext);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ApplicationEventPublisherAware) &#123;<br>				((ApplicationEventPublisherAware) bean).setApplicationEventPublisher(<span class="hljs-built_in">this</span>.applicationContext);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> MessageSourceAware) &#123;<br>				((MessageSourceAware) bean).setMessageSource(<span class="hljs-built_in">this</span>.applicationContext);<br>			&#125;<br>			<span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> ApplicationContextAware) &#123;<br>				((ApplicationContextAware) bean).setApplicationContext(<span class="hljs-built_in">this</span>.applicationContext);<br>			&#125;<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> &#123;<br>		<span class="hljs-keyword">return</span> bean;<br>	&#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>显然它也是一个BeanPostProcessor，我们看<code>postProcessBeforeInitialization</code>方法里面，判断了当前的bean是否实现了该接口，如果实现了就把获取到的applicationContext对象传给bean重写的<code>setApplicationContext</code>方法</p>
<p>也可以debug验证一下，这里就不贴debug的过程了</p>
<ul>
<li><code>BeanValidationPostProcessor</code>: 做数据校验</li>
<li><code>InitDestroyAnnotationBeanPostProcessor</code>: 处理<code>PostConstruct</code>和<code>PreDestroy</code>注解</li>
</ul>
<p>还记得之前讲的使用<code>PostConstruct</code>和<code>PreDestroy</code>注解来使spring调我们自己的方法吗，那两个注解起作用的背后就是<code>InitDestroyAnnotationBeanPostProcessor</code>在操作</p>
<p>话不多说，来debug</p>
<p>下面是方法调用栈</p>
<img src="./idea-debug-MyBeanPostProcessor.postProcessBeforeInitialization-2.png">

<p>这次就不从头开始看了，直接从<code>InitDestroyAnnotationBeanPostProcessor</code>的方法栈开始看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>	<span class="hljs-type">LifecycleMetadata</span> <span class="hljs-variable">metadata</span> <span class="hljs-operator">=</span> findLifecycleMetadata(bean.getClass()); <span class="hljs-comment">//找到dog bean的生命周期注解</span><br>	<span class="hljs-keyword">try</span> &#123;<br>		metadata.invokeInitMethods(bean, beanName);<span class="hljs-comment">//&lt;=========</span><br>	&#125;<br>	<span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Invocation of init method failed&quot;</span>, ex.getTargetException());<br>	&#125;<br>	<span class="hljs-keyword">catch</span> (Throwable ex) &#123;<br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName, <span class="hljs-string">&quot;Failed to invoke init method&quot;</span>, ex);<br>	&#125;<br>	<span class="hljs-keyword">return</span> bean;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后用<code>invokeInitMethods</code>执行指定的生命周期的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invokeInitMethods</span><span class="hljs-params">(Object target, String beanName)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>	Collection&lt;LifecycleElement&gt; initMethodsToIterate =<br>			(<span class="hljs-built_in">this</span>.checkedInitMethods != <span class="hljs-literal">null</span> ? <span class="hljs-built_in">this</span>.checkedInitMethods : <span class="hljs-built_in">this</span>.initMethods);<br>	<span class="hljs-keyword">if</span> (!initMethodsToIterate.isEmpty()) &#123;<br>		<span class="hljs-type">boolean</span> <span class="hljs-variable">debug</span> <span class="hljs-operator">=</span> logger.isDebugEnabled();<br>		<span class="hljs-keyword">for</span> (LifecycleElement element : initMethodsToIterate) &#123;<br>			<span class="hljs-keyword">if</span> (debug) &#123;<br>				logger.debug(<span class="hljs-string">&quot;Invoking init method on bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;: &quot;</span> + element.getMethod());<br>			&#125;<br>			element.invoke(target);<span class="hljs-comment">//&lt;=========</span><br>		&#125;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>进到这个invoke方法里面看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object target)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>	ReflectionUtils.makeAccessible(<span class="hljs-built_in">this</span>.method);<br>	<span class="hljs-built_in">this</span>.method.invoke(target, (Object[]) <span class="hljs-literal">null</span>);<span class="hljs-comment">//&lt;=========</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这里调到了java反射里面的method的invoke方法来执行</p>
<ul>
<li><code>AutowiredAnnotationBeanPostProcessor</code>: 用于处理<code>@Autowired</code>注解</li>
</ul>
<h3 id="属性赋值"><a href="#属性赋值" class="headerlink" title="属性赋值"></a>属性赋值</h3><h4 id="Value赋值"><a href="#Value赋值" class="headerlink" title="@Value赋值"></a><code>@Value</code>赋值</h4><p>主要功能为用指定的属性来初始化bean的属性</p>
<p>使用方法：</p>
<ul>
<li>直接赋值基本数据类型</li>
<li>使用SpEL表达式<code>#&#123;&#125;</code></li>
<li>可以用<code>$&#123;&#125;</code>取出配置文件中的值(环境变量中的值)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Documented;<br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Annotation at the field or method/constructor parameter level</span><br><span class="hljs-comment"> * that indicates a default value expression for the affected argument.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Typically used for expression-driven dependency injection. Also supported</span><br><span class="hljs-comment"> * for dynamic resolution of handler method parameters, e.g. in Spring MVC.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;A common use case is to assign default field values using</span><br><span class="hljs-comment"> * &quot;#&#123;systemProperties.myProp&#125;&quot; style expressions.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Note that actual processing of the &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Value</span>&#125; annotation is performed</span><br><span class="hljs-comment"> * by a &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.config.BeanPostProcessor</span><br><span class="hljs-comment"> * BeanPostProcessor&#125; which in turn means that you &lt;em&gt;cannot&lt;/em&gt; use</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Value</span>&#125; within</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.config.BeanPostProcessor</span><br><span class="hljs-comment"> * BeanPostProcessor&#125; or</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.config.BeanFactoryPostProcessor BeanFactoryPostProcessor&#125;</span><br><span class="hljs-comment"> * types. Please consult the javadoc for the &#123;<span class="hljs-doctag">@link</span> AutowiredAnnotationBeanPostProcessor&#125;</span><br><span class="hljs-comment"> * class (which, by default, checks for the presence of this annotation).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 3.0</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> AutowiredAnnotationBeanPostProcessor</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> Autowired</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.beans.factory.config.BeanExpressionResolver</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.beans.factory.support.AutowireCandidateResolver#getSuggestedValue</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(&#123;ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER, ElementType.ANNOTATION_TYPE&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Value &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The actual value expression: e.g. &quot;#&#123;systemProperties.myProp&#125;&quot;.</span><br><span class="hljs-comment">	 */</span><br>	String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> &#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 直接赋值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Value(&quot;张三&quot;)</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * SpEL表达式</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Value(&quot;#&#123;20-2&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> Integer age;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="PropertySource加载外部配置文件"><a href="#PropertySource加载外部配置文件" class="headerlink" title="@PropertySource加载外部配置文件"></a><code>@PropertySource</code>加载外部配置文件</h4><p>如何使用，先看源码里面的注释有没有说：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.context.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Documented;<br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Repeatable;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-keyword">import</span> org.springframework.core.io.support.PropertySourceFactory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Annotation providing a convenient and declarative mechanism for adding a</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.core.env.PropertySource PropertySource&#125; to Spring&#x27;s</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.core.env.Environment Environment&#125;. To be used in</span><br><span class="hljs-comment"> * conjunction with @&#123;<span class="hljs-doctag">@link</span> Configuration&#125; classes.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;h3&gt;Example usage&lt;/h3&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Given a file &#123;<span class="hljs-doctag">@code</span> app.properties&#125; containing the key/value pair</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> testbean.name=myTestBean&#125;, the following &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125; class</span><br><span class="hljs-comment"> * uses &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@PropertySource</span>&#125; to contribute &#123;<span class="hljs-doctag">@code</span> app.properties&#125; to the</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> Environment&#125;&#x27;s set of &#123;<span class="hljs-doctag">@code</span> PropertySources&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;pre class=&quot;code&quot;&gt;</span><br><span class="hljs-comment"> * &amp;#064;Configuration</span><br><span class="hljs-comment"> * &amp;#064;PropertySource(&quot;classpath:/com/myco/app.properties&quot;)</span><br><span class="hljs-comment"> * public class AppConfig &#123;</span><br><span class="hljs-comment"> *     &amp;#064;Autowired</span><br><span class="hljs-comment"> *     Environment env;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *     &amp;#064;Bean</span><br><span class="hljs-comment"> *     public TestBean testBean() &#123;</span><br><span class="hljs-comment"> *         TestBean testBean = new TestBean();</span><br><span class="hljs-comment"> *         testBean.setName(env.getProperty(&quot;testbean.name&quot;));</span><br><span class="hljs-comment"> *         return testBean;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;&lt;/pre&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Notice that the &#123;<span class="hljs-doctag">@code</span> Environment&#125; object is @&#123;<span class="hljs-doctag">@link</span></span><br><span class="hljs-comment"> * org.springframework.beans.factory.annotation.Autowired Autowired&#125; into the</span><br><span class="hljs-comment"> * configuration class and then used when populating the &#123;<span class="hljs-doctag">@code</span> TestBean&#125; object. Given</span><br><span class="hljs-comment"> * the configuration above, a call to &#123;<span class="hljs-doctag">@code</span> testBean.getName()&#125; will return &quot;myTestBean&quot;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;h3&gt;Resolving $&#123;...&#125; placeholders in &#123;<span class="hljs-doctag">@code</span> &lt;bean&gt;&#125; and &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Value</span>&#125; annotations&lt;/h3&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In order to resolve $&#123;...&#125; placeholders in &#123;<span class="hljs-doctag">@code</span> &lt;bean&gt;&#125; definitions or &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Value</span>&#125;</span><br><span class="hljs-comment"> * annotations using properties from a &#123;<span class="hljs-doctag">@code</span> PropertySource&#125;, one must register</span><br><span class="hljs-comment"> * a &#123;<span class="hljs-doctag">@code</span> PropertySourcesPlaceholderConfigurer&#125;. This happens automatically when using</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> &lt;context:property-placeholder&gt;&#125; in XML, but must be explicitly registered using</span><br><span class="hljs-comment"> * a &#123;<span class="hljs-doctag">@code</span> static&#125; &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Bean</span>&#125; method when using &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125; classes. See</span><br><span class="hljs-comment"> * the &quot;Working with externalized values&quot; section of @&#123;<span class="hljs-doctag">@link</span> Configuration&#125;&#x27;s javadoc and</span><br><span class="hljs-comment"> * &quot;a note on BeanFactoryPostProcessor-returning <span class="hljs-doctag">@Bean</span> methods&quot; of @&#123;<span class="hljs-doctag">@link</span> Bean&#125;&#x27;s javadoc</span><br><span class="hljs-comment"> * for details and examples.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;h3&gt;Resolving $&#123;...&#125; placeholders within &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@PropertySource</span>&#125; resource locations&lt;/h3&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Any $&#123;...&#125; placeholders present in a &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@PropertySource</span>&#125; &#123;<span class="hljs-doctag">@linkplain</span> #value()</span><br><span class="hljs-comment"> * resource location&#125; will be resolved against the set of property sources already</span><br><span class="hljs-comment"> * registered against the environment. For example:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;pre class=&quot;code&quot;&gt;</span><br><span class="hljs-comment"> * &amp;#064;Configuration</span><br><span class="hljs-comment"> * &amp;#064;PropertySource(&quot;classpath:/com/$&#123;my.placeholder:default/path&#125;/app.properties&quot;)</span><br><span class="hljs-comment"> * public class AppConfig &#123;</span><br><span class="hljs-comment"> *     &amp;#064;Autowired</span><br><span class="hljs-comment"> *     Environment env;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *     &amp;#064;Bean</span><br><span class="hljs-comment"> *     public TestBean testBean() &#123;</span><br><span class="hljs-comment"> *         TestBean testBean = new TestBean();</span><br><span class="hljs-comment"> *         testBean.setName(env.getProperty(&quot;testbean.name&quot;));</span><br><span class="hljs-comment"> *         return testBean;</span><br><span class="hljs-comment"> *     &#125;</span><br><span class="hljs-comment"> * &#125;&lt;/pre&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Assuming that &quot;my.placeholder&quot; is present in one of the property sources already</span><br><span class="hljs-comment"> * registered, e.g. system properties or environment variables, the placeholder will</span><br><span class="hljs-comment"> * be resolved to the corresponding value. If not, then &quot;default/path&quot; will be used as a</span><br><span class="hljs-comment"> * default. Expressing a default value (delimited by colon &quot;:&quot;) is optional.  If no</span><br><span class="hljs-comment"> * default is specified and a property cannot be resolved, an &#123;<span class="hljs-doctag">@code</span></span><br><span class="hljs-comment"> * IllegalArgumentException&#125; will be thrown.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;h3&gt;A note on property overriding with <span class="hljs-doctag">@PropertySource</span>&lt;/h3&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In cases where a given property key exists in more than one &#123;<span class="hljs-doctag">@code</span> .properties&#125;</span><br><span class="hljs-comment"> * file, the last &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@PropertySource</span>&#125; annotation processed will &#x27;win&#x27; and override.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * For example, given two properties files &#123;<span class="hljs-doctag">@code</span> a.properties&#125; and</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> b.properties&#125;, consider the following two configuration classes</span><br><span class="hljs-comment"> * that reference them with &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@PropertySource</span>&#125; annotations:</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;pre class=&quot;code&quot;&gt;</span><br><span class="hljs-comment"> * &amp;#064;Configuration</span><br><span class="hljs-comment"> * &amp;#064;PropertySource(&quot;classpath:/com/myco/a.properties&quot;)</span><br><span class="hljs-comment"> * public class ConfigA &#123; &#125;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &amp;#064;Configuration</span><br><span class="hljs-comment"> * &amp;#064;PropertySource(&quot;classpath:/com/myco/b.properties&quot;)</span><br><span class="hljs-comment"> * public class ConfigB &#123; &#125;</span><br><span class="hljs-comment"> * &lt;/pre&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * The override ordering depends on the order in which these classes are registered</span><br><span class="hljs-comment"> * with the application context.</span><br><span class="hljs-comment"> * &lt;pre class=&quot;code&quot;&gt;</span><br><span class="hljs-comment"> * AnnotationConfigApplicationContext ctx =</span><br><span class="hljs-comment"> *     new AnnotationConfigApplicationContext();</span><br><span class="hljs-comment"> * ctx.register(ConfigA.class);</span><br><span class="hljs-comment"> * ctx.register(ConfigB.class);</span><br><span class="hljs-comment"> * ctx.refresh();</span><br><span class="hljs-comment"> * &lt;/pre&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * In the scenario above, the properties in &#123;<span class="hljs-doctag">@code</span> b.properties&#125; will override any</span><br><span class="hljs-comment"> * duplicates that exist in &#123;<span class="hljs-doctag">@code</span> a.properties&#125;, because &#123;<span class="hljs-doctag">@code</span> ConfigB&#125; was registered</span><br><span class="hljs-comment"> * last.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;In certain situations, it may not be possible or practical to tightly control</span><br><span class="hljs-comment"> * property source ordering when using &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@ProperySource</span>&#125; annotations. For example,</span><br><span class="hljs-comment"> * if the &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125; classes above were registered via component-scanning,</span><br><span class="hljs-comment"> * the ordering is difficult to predict. In such cases - and if overriding is important -</span><br><span class="hljs-comment"> * it is recommended that the user fall back to using the programmatic PropertySource API.</span><br><span class="hljs-comment"> * See &#123;<span class="hljs-doctag">@link</span> org.springframework.core.env.ConfigurableEnvironment ConfigurableEnvironment&#125;</span><br><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@link</span> org.springframework.core.env.MutablePropertySources MutablePropertySources&#125;</span><br><span class="hljs-comment"> * javadocs for details.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Chris Beams</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Phillip Webb</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 3.1</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> PropertySources</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> Configuration</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.core.env.PropertySource</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.core.env.ConfigurableEnvironment#getPropertySources()</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.core.env.MutablePropertySources</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Repeatable(PropertySources.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> PropertySource &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicate the name of this property source. If omitted, a name will</span><br><span class="hljs-comment">	 * be generated based on the description of the underlying resource.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.env.PropertySource#getName()</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.io.Resource#getDescription()</span><br><span class="hljs-comment">	 */</span><br>	String <span class="hljs-title function_">name</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicate the resource location(s) of the properties file to be loaded.</span><br><span class="hljs-comment">	 * For example, &#123;<span class="hljs-doctag">@code</span> &quot;classpath:/com/myco/app.properties&quot;&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> &quot;file:/path/to/file&quot;&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;Resource location wildcards (e.g. *&amp;#42;/*.properties) are not permitted;</span><br><span class="hljs-comment">	 * each location must evaluate to exactly one &#123;<span class="hljs-doctag">@code</span> .properties&#125; resource.</span><br><span class="hljs-comment">	 * &lt;p&gt;$&#123;...&#125; placeholders will be resolved against any/all property sources already</span><br><span class="hljs-comment">	 * registered with the &#123;<span class="hljs-doctag">@code</span> Environment&#125;. See &#123;<span class="hljs-doctag">@linkplain</span> PropertySource above&#125;</span><br><span class="hljs-comment">	 * for examples.</span><br><span class="hljs-comment">	 * &lt;p&gt;Each location will be added to the enclosing &#123;<span class="hljs-doctag">@code</span> Environment&#125; as its own</span><br><span class="hljs-comment">	 * property source, and in the order declared.</span><br><span class="hljs-comment">	 */</span><br>	String[] value();<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicate if failure to find the a &#123;<span class="hljs-doctag">@link</span> #value() property resource&#125; should be</span><br><span class="hljs-comment">	 * ignored.</span><br><span class="hljs-comment">	 * &lt;p&gt;&#123;<span class="hljs-doctag">@code</span> true&#125; is appropriate if the properties file is completely optional.</span><br><span class="hljs-comment">	 * Default is &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 4.0</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">ignoreResourceNotFound</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * A specific character encoding for the given resources, e.g. &quot;UTF-8&quot;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 4.3</span><br><span class="hljs-comment">	 */</span><br>	String <span class="hljs-title function_">encoding</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Specify a custom &#123;<span class="hljs-doctag">@link</span> PropertySourceFactory&#125;, if any.</span><br><span class="hljs-comment">	 * &lt;p&gt;By default, a default factory for standard resource files will be used.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 4.3</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.io.support.DefaultPropertySourceFactory</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.core.io.support.ResourcePropertySource</span><br><span class="hljs-comment">	 */</span><br>	Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PropertySourceFactory</span>&gt; factory() <span class="hljs-keyword">default</span> PropertySourceFactory.class;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>显然该注解作用的对象是类，保留到运行时</p>
<p>再看参数：</p>
<ul>
<li><code>String[] value()</code></li>
</ul>
<blockquote>
<p>Indicate the resource location(s) of the properties file to be loaded.</p>
</blockquote>
<p>这个参数用于指定配置文件的路径</p>
<p>实践一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Person;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.PropertySource;<br><span class="hljs-comment">// 使用@PropertySource读取额外外部配置文件中的k/v保存到运行环境的环境变量中；加载完外部的配置文件后使用$&#123;&#125;取出配置文件中的值</span><br><span class="hljs-meta">@PropertySource(value = &#123;&quot;classpath:/person.properties&quot;&#125;, encoding = &quot;UTF-8&quot;)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfigOfPropertyValues</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Person <span class="hljs-title function_">person</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在Person类中加入一个字段用于赋值properties文件中配置的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Value(&quot;$&#123;person.nickname&#125;&quot;)</span><br><span class="hljs-keyword">private</span> String nickname;<br></code></pre></td></tr></table></figure>

<p>person.properties：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs .properties">person.nickname=法外狂徒<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mainConfigOfPropertyValues<br>person<br>Person&#123;name=&#x27;张三&#x27;, age=18, nickname=&#x27;法外狂徒&#x27;&#125;<br></code></pre></td></tr></table></figure>

<p>值得注意的是这里使用<code>@Value(&quot;$&#123;person.nickname&#125;&quot;)</code>获取到的是运行时环境变量中的值，也就是说还可以直接读取运行时环境变量来获取该值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ConfigurableEnvironment</span> <span class="hljs-variable">environment</span> <span class="hljs-operator">=</span> applicationContext.getEnvironment();<br><span class="hljs-type">String</span> <span class="hljs-variable">property</span> <span class="hljs-operator">=</span> environment.getProperty(<span class="hljs-string">&quot;person.nickname&quot;</span>);<br>System.out.println(property);<br></code></pre></td></tr></table></figure>

<h3 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h3><p>自动装配：Spring利用依赖注入(DI)来完成对IOC容器中各个组件的依赖关系的赋值</p>
<h4 id="Autowired-amp-Qualifier-amp-Primary"><a href="#Autowired-amp-Qualifier-amp-Primary" class="headerlink" title="@Autowired &amp; @Qualifier &amp; @Primary"></a><code>@Autowired</code> &amp; <code>@Qualifier</code> &amp; <code>@Primary</code></h4><ul>
<li><code>@Autowired</code>: 自动注入<ol>
<li>优先按照容器类型去容器中找对应的组件：等价于<code>applicationContext.getBean(BookService.class)</code>，找到就赋值</li>
<li>如果找到多个相同类型的组件，则将属性名作为组件的id去容器中查找，等价于<code>applicationContext.getBean(&quot;bookDao&quot;)</code></li>
<li>这里若不想将属性名作为组件的id去容器中查找的话可以使用<code>@Qualifier(&quot;bookDao&quot;)</code>注解在属性上来手动指定组件的id</li>
<li>自动装配默认一定要将属性赋值好，没有就报错，除非设置为非必须<code>@Autowired(required = false)</code></li>
<li><code>@Primary</code>让Spring进行自动装配的时候默认使用首选的bean，注：该优先级低于@Qualifier明确指定的优先级</li>
</ol>
</li>
</ul>
<p><code>@Autowired</code>注解大家都用的比较多这里就不贴代码了，简单的测试一下将bookDao注入bookService里，然后从IOT容器中取出bookDao和bookService，通过比较发现bookService里的bookDao对象和IOT容器中的bookDao对象是同一个</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">BookService&#123;bookDao=com.sicmatr1x.dao.BookDao@25b485ba&#125;<br>com.sicmatr1x.dao.BookDao@25b485ba<br></code></pre></td></tr></table></figure>

<h4 id="Resource-amp-Inject"><a href="#Resource-amp-Inject" class="headerlink" title="@Resource &amp; @Inject"></a><code>@Resource</code> &amp; <code>@Inject</code></h4><p>Spring还支持<code>@Resource</code>(定义在JSR250) 和 <code>@Inject</code>(定义在JSR330)，注意这两个注解是java规范里面的注解</p>
<ul>
<li><code>@Resource</code>注解与<code>@Autowired</code>注解类似，可以用于实现自动装配的功能，默认按照组件名称装配</li>
<li><code>@Inject</code>使用此注解需要导入依赖，不支持修改为require&#x3D;false也不支持@Primary</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/javax.inject/javax.inject --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.inject<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.inject<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>使用<code>@Inject</code>注解可能会在日志中输出下面这句话，这句话表面<code>@Inject</code>也支持许多自动装配的特性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">INFO: JSR-330 &#x27;javax.inject.Inject&#x27; annotation found and supported for autowiring<br></code></pre></td></tr></table></figure>

<h4 id="方法、构造器位置的自动装配"><a href="#方法、构造器位置的自动装配" class="headerlink" title="方法、构造器位置的自动装配"></a>方法、构造器位置的自动装配</h4><p><code>@Autowired</code>可以用在构造器、参数、方法、属性上面，并且注入的bean均是从IOT容器中获取已经托管的bean，以下将会试验并证明这一点</p>
<ol>
<li>将<code>@Autowired</code>标注在set方法上</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Boss</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Car car;<br><br>    <span class="hljs-keyword">public</span> Car <span class="hljs-title function_">getCar</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> car;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 标注在方法上时，spring容器创建当前对象会调用该方法完成赋值</span><br><span class="hljs-comment">     * 方法使用的参数，自定义类型的值从IOC容器中获取</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> car</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCar</span><span class="hljs-params">(Car car)</span> &#123;<br>        <span class="hljs-built_in">this</span>.car = car;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Boss&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;car=&quot;</span> + car +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>从IOC容器中get出来看一下是否boss对象里面set进去的car对象就是从IOT容器中获取的那个car对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Boss</span> <span class="hljs-variable">boss</span> <span class="hljs-operator">=</span> applicationContext.getBean(Boss.class);<br><span class="hljs-type">Car</span> <span class="hljs-variable">car</span> <span class="hljs-operator">=</span> applicationContext.getBean(Car.class);<br>System.out.println(boss);<br>System.out.println(car);<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Boss&#123;car=com.sicmatr1x.bean.Car@5b0abc94&#125;<br>com.sicmatr1x.bean.Car@5b0abc94<br></code></pre></td></tr></table></figure>

<p>可以看到是同一个car对象</p>
<ol start="2">
<li>将<code>@Autowired</code>标注在构造器上</li>
</ol>
<p>默认加入到IOC容器中的组件，容器在启动时会调用其无参构造器创建对象，再进行初始化赋值等操作</p>
<p>如果组件只有一个有参构造器，这个有参构造器的@Autowired可以省略，参数位置的组件还是可以自动从容器中获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Boss</span> &#123;<br>    <span class="hljs-keyword">private</span> Car car;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Boss</span><span class="hljs-params">(Car car)</span> &#123;<br>        <span class="hljs-built_in">this</span>.car = car;<br>        System.out.println(<span class="hljs-string">&quot;Boss:constructor()&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Car <span class="hljs-title function_">getCar</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> car;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setCar</span><span class="hljs-params">(Car car)</span> &#123;<br>        <span class="hljs-built_in">this</span>.car = car;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Boss&#123;&quot;</span> +<br>                <span class="hljs-string">&quot;car=&quot;</span> + car +<br>                <span class="hljs-string">&#x27;&#125;&#x27;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Car:constructor<br>Boss:constructor()<br>Boss&#123;car=com.sicmatr1x.bean.Car@214b199c&#125;<br>com.sicmatr1x.bean.Car@214b199c<br></code></pre></td></tr></table></figure>

<p>说明构造器用到的组件也都是从容器中获取</p>
<p>下面这种用法也定价于上面的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Boss</span><span class="hljs-params">(<span class="hljs-meta">@Autowired</span> Car car)</span> &#123;<br>    <span class="hljs-built_in">this</span>.car = car;<br>    System.out.println(<span class="hljs-string">&quot;Boss:constructor()&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以在构造器上面使用<code>@Bean</code>注解，效果是一样的</p>
<p>如果你的自定义组件想要使用Spring容器底层的一些组件，例如：ApplicationContext, BeanFactory…可以通过自定义组件实现xxxAware的方法</p>
<p>比如之前讲过的Dog类通过实现<code>ApplicationContextAware</code>接口来获取到ApplicationContext对象</p>
<p>这里再看一下<code>ApplicationContextAware</code>接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ApplicationContextAware</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Aware</span> &#123;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到该类实现了<code>Aware</code>接口，点进去看一下Aware：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Marker superinterface indicating that a bean is eligible to be</span><br><span class="hljs-comment"> * notified by the Spring container of a particular framework object</span><br><span class="hljs-comment"> * through a callback-style method. Actual method signature is</span><br><span class="hljs-comment"> * determined by individual subinterfaces, but should typically</span><br><span class="hljs-comment"> * consist of just one void-returning method that accepts a single</span><br><span class="hljs-comment"> * argument.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Note that merely implementing &#123;<span class="hljs-doctag">@link</span> Aware&#125; provides no default</span><br><span class="hljs-comment"> * functionality. Rather, processing must be done explicitly, for example</span><br><span class="hljs-comment"> * in a &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.config.BeanPostProcessor BeanPostProcessor&#125;.</span><br><span class="hljs-comment"> * Refer to &#123;<span class="hljs-doctag">@link</span> org.springframework.context.support.ApplicationContextAwareProcessor&#125;</span><br><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@link</span> org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory&#125;</span><br><span class="hljs-comment"> * for examples of processing &#123;<span class="hljs-doctag">@code</span> *Aware&#125; interface callbacks.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Chris Beams</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 3.1</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Aware</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<blockquote>
<p>Marker superinterface indicating that a bean is eligible to be notified by the Spring container of a particular framework object through a callback-style method.</p>
</blockquote>
<p>显然这个接口是一个标记接口，其提供了一个回调风格的方法来让你获取到一个特定的 framework object</p>
<p>这里演示几个常用的Aware接口的实现接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.bean;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.BeansException;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.BeanNameAware;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContextAware;<br><span class="hljs-keyword">import</span> org.springframework.context.EmbeddedValueResolverAware;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<br><span class="hljs-keyword">import</span> org.springframework.util.StringValueResolver;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Red</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ApplicationContextAware</span>, BeanNameAware, EmbeddedValueResolverAware &#123;<br><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * BeanNameAware</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> name 获取IOC容器创建该对象时给这个对象生成的id</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBeanName</span><span class="hljs-params">(String name)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;Red:setBeanName():Current bean name=&quot;</span> + name);<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * ApplicationContextAware</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> applicationContext 获取IOC容器对象</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> BeansException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setApplicationContext</span><span class="hljs-params">(ApplicationContext applicationContext)</span> <span class="hljs-keyword">throws</span> BeansException &#123;<br>        System.out.println(<span class="hljs-string">&quot;Red:setApplicationContext():applicationContext=&quot;</span> + applicationContext);<br>        <span class="hljs-built_in">this</span>.applicationContext = applicationContext;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * EmbeddedValueResolverAware</span><br><span class="hljs-comment">     * Set the StringValueResolver to use for resolving embedded definition values.</span><br><span class="hljs-comment">     * 获取字符串解析器</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> resolver</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEmbeddedValueResolver</span><span class="hljs-params">(StringValueResolver resolver)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resolver.resolveStringValue(<span class="hljs-string">&quot;Hello, $&#123;os.name&#125;. #&#123;15*10&#125;&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;Red:setEmbeddedValueResolver():result=&quot;</span> + result);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">Red:setBeanName():Current bean name=red<br>Red:setEmbeddedValueResolver():result=Hello, Windows 10. 150<br>Red:setApplicationContext():applicationContext=org.springframework.context.annotation.<br></code></pre></td></tr></table></figure>

<h4 id="Profile环境搭建"><a href="#Profile环境搭建" class="headerlink" title="@Profile环境搭建"></a><code>@Profile</code>环境搭建</h4><p>Spring提供的可以根据当前环境动态激活一系列组件的功能</p>
<p>这里我们拟真一下有3个场的mysql数据源管理：</p>
<p>先在pom.xml中引入数据源包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/com.mchange/c3p0 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mchange<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>c3p0<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>创建数据源配置文件dbconfig.properties：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">db.user</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">db.password</span>=<span class="hljs-string">123456</span><br><span class="hljs-attr">db.driverClass</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br></code></pre></td></tr></table></figure>

<p>创建数据源配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.mchange.v2.c3p0.ComboPooledDataSource;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;<br><span class="hljs-keyword">import</span> org.springframework.context.EmbeddedValueResolverAware;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.PropertySource;<br><span class="hljs-keyword">import</span> org.springframework.util.StringValueResolver;<br><br><span class="hljs-keyword">import</span> javax.sql.DataSource;<br><span class="hljs-keyword">import</span> java.beans.PropertyVetoException;<br><br><span class="hljs-meta">@PropertySource(&quot;classpath:/dbconfig.properties&quot;)</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfigOfProfile</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">EmbeddedValueResolverAware</span> &#123;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;db.user&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String user;<br><br>    <span class="hljs-keyword">private</span> StringValueResolver valueResolver;<br><br>    <span class="hljs-meta">@Bean(&quot;devDataSource&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSourceDev</span><span class="hljs-params">(<span class="hljs-meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span> String pwd)</span> <span class="hljs-keyword">throws</span> PropertyVetoException &#123;<br>        <span class="hljs-type">ComboPooledDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComboPooledDataSource</span>();<br>        dataSource.setUser(user);<br>        dataSource.setPassword(pwd);<br>        dataSource.setJdbcUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/&quot;</span>);<br>        dataSource.setDriverClass(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean(&quot;testDataSource&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSourceTest</span><span class="hljs-params">(<span class="hljs-meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span> String pwd)</span> <span class="hljs-keyword">throws</span> PropertyVetoException &#123;<br>        <span class="hljs-type">ComboPooledDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComboPooledDataSource</span>();<br>        dataSource.setUser(user);<br>        dataSource.setPassword(pwd);<br>        dataSource.setJdbcUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>);<br>        dataSource.setDriverClass(<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>);<br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br>    <span class="hljs-meta">@Bean(&quot;prodDataSource&quot;)</span><br>    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">dataSourceProd</span><span class="hljs-params">(<span class="hljs-meta">@Value(&quot;$&#123;db.password&#125;&quot;)</span> String pwd)</span> <span class="hljs-keyword">throws</span> PropertyVetoException &#123;<br>        <span class="hljs-type">ComboPooledDataSource</span> <span class="hljs-variable">dataSource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ComboPooledDataSource</span>();<br>        dataSource.setUser(user);<br>        dataSource.setPassword(pwd);<br>        dataSource.setJdbcUrl(<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">driverName</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.valueResolver.resolveStringValue(<span class="hljs-string">&quot;$&#123;db.driverClass&#125;&quot;</span>);<br>        dataSource.setDriverClass(driverName);<br>        <span class="hljs-keyword">return</span> dataSource;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setEmbeddedValueResolver</span><span class="hljs-params">(StringValueResolver resolver)</span> &#123;<br>        <span class="hljs-built_in">this</span>.valueResolver = resolver;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>这里用到了<code>@PropertySource</code>读取配置文件，以及el表达式从配置文件里读取配置项</p>
<p>还用到了EmbeddedValueResolverAware来获取<code>StringValueResolver</code></p>
<p>写测试类run一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Boss;<br><span class="hljs-keyword">import</span> com.sicmatr1x.bean.Car;<br><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfigOfAutowired;<br><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfigOfProfile;<br><span class="hljs-keyword">import</span> com.sicmatr1x.dao.BookDao;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Primary;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOCTest_Profile</span> &#123;<br><br>    <span class="hljs-meta">@Primary</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> BookDao <span class="hljs-title function_">bookDao</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BookDao</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfigOfProfile.class);<br>        String[] beanNames = applicationContext.getBeanDefinitionNames();<br>        <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;<br>            System.out.println(beanName);<br>        &#125;<br>        applicationContext.close();<br>    &#125;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">mainConfigOfProfile<br>devDataSource<br>testDataSource<br>prodDataSource<br></code></pre></td></tr></table></figure>

<p>可以看到几个数据源已经正确的添加进来了</p>
<h3 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h3><p>指在程序运行期间将某段代码切入到指定方法指定位置的进行运行的编程方式。其底层实现是动态代理</p>
<h4 id="AOP功能测试"><a href="#AOP功能测试" class="headerlink" title="AOP功能测试"></a>AOP功能测试</h4><ol>
<li>导入AOP模块</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aspects<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.12.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<ol start="2">
<li>创建业务逻辑类(MathCalculator)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.aop;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MathCalculator</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">div</span><span class="hljs-params">(<span class="hljs-type">int</span> i, <span class="hljs-type">int</span> j)</span> &#123;<br>        <span class="hljs-keyword">return</span> i/j;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>我们希望在业务逻辑运行的时候将日志进行打印</p>
<p>若我们直接在<code>div(int i, int j)</code>方法里面添加打印语句则是一个高耦合的做法</p>
<ol start="3">
<li>定义一个日志切面类(LogAspects), 切面类里面的方法需要可以动态感知<code>div(int i, int j)</code>方法运行状态</li>
</ol>
<p>相当于通知方法：</p>
<ul>
<li>前置通知(@Before)：在目标方法运行之前运行</li>
<li>后置通知(@After)：在目标方法运行之后运行</li>
<li>返回通知(@AfterReturning)：在目标方法正常返回之后运行</li>
<li>异常通知(@AfterThrowing)：在目标方法运行出现异常后运行</li>
<li>环绕通知(@Around)：动态代理，手动推进目标方法运行(<code>joinPoint.procced()</code>)</li>
</ul>
<ol start="4">
<li>给切面类(LogAspects)的目标方法标注何时运行</li>
</ol>
<ul>
<li>@Before(“com.sicmatr1x.aop.MathCalculator.div(int, int)”)：指定具体的需要切入的方法</li>
<li>@Before(“com.sicmatr1x.aop.MathCalculator.*(int, int)”)：切入MathCalculator的所有形参表的方法</li>
<li>@Before(“com.sicmatr1x.aop.MathCalculator.*(..)”)：切入MathCalculator类的所有方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@Before(&quot;com.sicmatr1x.aop.MathCalculator.*(..)&quot;)</span><br><span class="hljs-comment">//    @Before(&quot;com.sicmatr1x.aop.MathCalculator.div(int, int)&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div is starting, args:&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>如果多个切入点表达式一样的话可以抽取出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.aop;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 切面类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspects</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 抽取公共的切入点表达式</span><br><span class="hljs-comment">     * 1. 本类引用 <span class="hljs-doctag">@Before</span>(&quot;pointCut()&quot;)</span><br><span class="hljs-comment">     * 2. 其它类引用 <span class="hljs-doctag">@Before</span>(&quot;com.sicmatr1x.aop.LogAspects.pointCut()&quot;)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Pointcut(&quot;execution(public int com.sicmatr1x.aop.MathCalculator.*(..))&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span>&#123;&#125;<br><br>    <span class="hljs-meta">@Before(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div is starting, args:&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div is ending&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div is return, value:&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterThrowing(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div throws exception, error message:&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ol start="5">
<li>将切面类LogAspects和业务逻辑类MathCalculator都加入到容器中</li>
</ol>
<p>并使用@EnableAspectJAutoProxy注解开启Spring 基于注解的AOP功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.config;<br><br><span class="hljs-keyword">import</span> com.sicmatr1x.aop.LogAspects;<br><span class="hljs-keyword">import</span> com.sicmatr1x.aop.MathCalculator;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;<br><br><span class="hljs-meta">@EnableAspectJAutoProxy</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainConfigOfAOP</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> MathCalculator <span class="hljs-title function_">mathCalculator</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MathCalculator</span>();<br>    &#125;<br><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> LogAspects <span class="hljs-title function_">logAspects</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LogAspects</span>();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<ol start="6">
<li>告诉Spring哪个类是切面类</li>
</ol>
<p>给切面类加上@Aspect注解即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspects</span> &#123;<br>	<span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>编写测试类进行测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sicmatr1x.aop.MathCalculator;<br><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfigOfAOP;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOCTest_AOP</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 创建IOC容器</span><br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfigOfAOP.class);<br><br>        <span class="hljs-type">MathCalculator</span> <span class="hljs-variable">mathCalculator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MathCalculator</span>();<br>        mathCalculator.div(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>        <br>        applicationContext.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出结果中并没有输出任何东西，为什么呢，如果你是这样写测试类的话是不会有效果的，因为你使用的是自己new出来的一个MathCalculator对象而不是用脱光到IOT容器中的那个对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sicmatr1x.aop.MathCalculator;<br><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfigOfAOP;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOCTest_AOP</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 创建IOC容器</span><br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfigOfAOP.class);<br>        <span class="hljs-comment">// 自己new的对象没有AOP功能</span><br><span class="hljs-comment">//        MathCalculator mathCalculator = new MathCalculator();</span><br><span class="hljs-comment">//        mathCalculator.div(1,1);</span><br><br>        <span class="hljs-comment">// 从Spring容器中的对象才有AOP功能</span><br>        <span class="hljs-type">MathCalculator</span> <span class="hljs-variable">mathCalculator</span> <span class="hljs-operator">=</span> applicationContext.getBean(MathCalculator.class);<br>        mathCalculator.div(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><br>        applicationContext.close();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">div is starting, args:<br>div is ending<br>div is return, value:<br></code></pre></td></tr></table></figure>

<p>可以看到切面执行顺序是@Before, @After, @AfterReturning</p>
<p>刚刚忘记写输出args:的代码了，我们再来升级一下切面类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.sicmatr1x.aop;<br><br><span class="hljs-keyword">import</span> org.aspectj.lang.JoinPoint;<br><span class="hljs-keyword">import</span> org.aspectj.lang.annotation.*;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 切面类</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogAspects</span> &#123;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 抽取公共的切入点表达式</span><br><span class="hljs-comment">     * 1. 本类引用 <span class="hljs-doctag">@Before</span>(&quot;pointCut()&quot;)</span><br><span class="hljs-comment">     * 2. 其它类引用 <span class="hljs-doctag">@Before</span>(&quot;com.sicmatr1x.aop.LogAspects.pointCut()&quot;)</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Pointcut(&quot;execution(public int com.sicmatr1x.aop.MathCalculator.*(..))&quot;)</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointCut</span><span class="hljs-params">()</span>&#123;&#125;<br><br>    <span class="hljs-meta">@Before(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logStart</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        Object[] args = joinPoint.getArgs();<br>        System.out.print(joinPoint.getSignature().getName() + <span class="hljs-string">&quot; div is starting, args:&quot;</span>);<br>        <span class="hljs-keyword">for</span>(Object arg: args) &#123;<br>            System.out.print(arg + <span class="hljs-string">&quot;,&quot;</span>);<br>        &#125;<br>        System.out.println();<br>    &#125;<br><br>    <span class="hljs-meta">@After(&quot;pointCut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logEnd</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        System.out.println(joinPoint.getSignature().getName() + <span class="hljs-string">&quot; div is ending&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterReturning(value = &quot;pointCut()&quot;, returning = &quot;result&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logReturn</span><span class="hljs-params">(Object result)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div is return, value:&quot;</span> + result);<br>    &#125;<br><br>    <span class="hljs-meta">@AfterThrowing(value = &quot;pointCut()&quot;, throwing = &quot;exception&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logException</span><span class="hljs-params">(Exception exception)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;div throws exception, error message:&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">div div is starting, args:1,1,<br>div div is ending<br>div is return, value:1<br></code></pre></td></tr></table></figure>

<h4 id="AOP原理解析-EnableAspectJAutoProxyCreator"><a href="#AOP原理解析-EnableAspectJAutoProxyCreator" class="headerlink" title="AOP原理解析 @EnableAspectJAutoProxyCreator"></a>AOP原理解析 <code>@EnableAspectJAutoProxyCreator</code></h4><p>从上述AOP demo可以看出关键的一步是给spring开启AOP功能，所以我们先从这里开始看</p>
<p>点进@EnableAspectJAutoProxy注解看源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(AspectJAutoProxyRegistrar.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAspectJAutoProxy &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicate whether subclass-based (CGLIB) proxies are to be created as opposed</span><br><span class="hljs-comment">	 * to standard Java interface-based proxies. The default is &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">proxyTargetClass</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicate that the proxy should be exposed by the AOP framework as a &#123;<span class="hljs-doctag">@code</span> ThreadLocal&#125;</span><br><span class="hljs-comment">	 * for retrieval via the &#123;<span class="hljs-doctag">@link</span> org.springframework.aop.framework.AopContext&#125; class.</span><br><span class="hljs-comment">	 * Off by default, i.e. no guarantees that &#123;<span class="hljs-doctag">@code</span> AopContext&#125; access will work.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 4.3.1</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">exposeProxy</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这里用到了一个叫AspectJAutoProxyRegistrar的类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Registers an &#123;<span class="hljs-doctag">@link</span> org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator</span><br><span class="hljs-comment"> * AnnotationAwareAspectJAutoProxyCreator&#125; against the current &#123;<span class="hljs-doctag">@link</span> BeanDefinitionRegistry&#125;</span><br><span class="hljs-comment"> * as appropriate based on a given @&#123;<span class="hljs-doctag">@link</span> EnableAspectJAutoProxy&#125; annotation.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Chris Beams</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 3.1</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> EnableAspectJAutoProxy</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">AspectJAutoProxyRegistrar</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ImportBeanDefinitionRegistrar</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Register, escalate, and configure the AspectJ auto proxy creator based on the value</span><br><span class="hljs-comment">	 * of the @&#123;<span class="hljs-doctag">@link</span> EnableAspectJAutoProxy#proxyTargetClass()&#125; attribute on the importing</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Configuration</span>&#125; class.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerBeanDefinitions</span><span class="hljs-params">(</span><br><span class="hljs-params">			AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;<br><br>		AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);<br><br>		<span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">enableAspectJAutoProxy</span> <span class="hljs-operator">=</span><br>				AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);<br>		<span class="hljs-keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="hljs-string">&quot;proxyTargetClass&quot;</span>)) &#123;<br>			AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);<br>		&#125;<br>		<span class="hljs-keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="hljs-string">&quot;exposeProxy&quot;</span>)) &#123;<br>			AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);<br>		&#125;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到AspectJAutoProxyRegistrar这个类是一个ImportBeanDefinitionRegistrar接口的实现</p>
<p>我们之前也实现过这个接口，实现类<code>MyImportBeanDefinitionRegistrar</code>，我们当时使用的功能是判断容器中有没有指定的bean，若有则再注册一个给定的bean到容器中</p>
<p>打个断点从<code>AopConfigUtils.registerAspectJAnnotationAutoProxyCreatorIfNecessary(registry);</code>这里进入，看下注册了啥</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanDefinition <span class="hljs-title function_">registerOrEscalateApcAsRequired</span><span class="hljs-params">(Class&lt;?&gt; cls, BeanDefinitionRegistry registry, Object source)</span> &#123;<br>	Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);<br>	<span class="hljs-keyword">if</span> (registry.containsBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME)) &#123;<br>		<span class="hljs-type">BeanDefinition</span> <span class="hljs-variable">apcDefinition</span> <span class="hljs-operator">=</span> registry.getBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME);<br>		<span class="hljs-keyword">if</span> (!cls.getName().equals(apcDefinition.getBeanClassName())) &#123;<br>			<span class="hljs-type">int</span> <span class="hljs-variable">currentPriority</span> <span class="hljs-operator">=</span> findPriorityForClass(apcDefinition.getBeanClassName());<br>			<span class="hljs-type">int</span> <span class="hljs-variable">requiredPriority</span> <span class="hljs-operator">=</span> findPriorityForClass(cls);<br>			<span class="hljs-keyword">if</span> (currentPriority &lt; requiredPriority) &#123;<br>				apcDefinition.setBeanClassName(cls.getName());<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>	&#125;<br>	<span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">beanDefinition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(cls);<br>	beanDefinition.setSource(source);<br>	beanDefinition.getPropertyValues().add(<span class="hljs-string">&quot;order&quot;</span>, Ordered.HIGHEST_PRECEDENCE);<br>	beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);<br>	registry.registerBeanDefinition(AUTO_PROXY_CREATOR_BEAN_NAME, beanDefinition);<br>	<span class="hljs-keyword">return</span> beanDefinition;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>显然这里向容器中注册了一个ID为<code>AUTO_PROXY_CREATOR_BEAN_NAME=org.springframework.aop.config.internalAutoProxyCreator</code>的bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">enableAspectJAutoProxy</span> <span class="hljs-operator">=</span><br>		AnnotationConfigUtils.attributesFor(importingClassMetadata, EnableAspectJAutoProxy.class);<br><span class="hljs-keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="hljs-string">&quot;proxyTargetClass&quot;</span>)) &#123;<br>	AopConfigUtils.forceAutoProxyCreatorToUseClassProxying(registry);<br>&#125;<br><span class="hljs-keyword">if</span> (enableAspectJAutoProxy.getBoolean(<span class="hljs-string">&quot;exposeProxy&quot;</span>)) &#123;<br>	AopConfigUtils.forceAutoProxyCreatorToExposeProxy(registry);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后它拿了@EnableAspectJAutoProxy注解的信息并判断其属性proxyTargetClass, exposeProxy的值，并做相应的操作</p>
<p>总结：在使用了@EnableAspectJAutoProxy注解之后发生了以下的事情</p>
<ol>
<li><code>@Import(AspectJAutoProxyRegistrar.class)</code>给容器中导入了AspectJAutoProxyRegistrar</li>
<li>利用AspectJAutoProxyRegistrar类自定义给容器中注册bean</li>
<li>internalAutoProxyCreator&#x3D;AnnotationAwareAspectJAutoProxyCreator</li>
<li>给容器中注册一个AnnotationAwareAspectJAutoProxyCreator</li>
<li>AnnotationAwareAspectJAutoProxyCreator：<ul>
<li>AnnotationAwareAspectJAutoProxyCreator extends AspectJAwareAdvisorAutoProxyCreator<ul>
<li>AspectJAwareAdvisorAutoProxyCreator extends AbstractAdvisorAutoProxyCreator<ul>
<li>AspectJAwareAdvisorAutoProxyCreator extends AbstractAdvisorAutoProxyCreator<ul>
<li>AbstractAdvisorAutoProxyCreator extends AbstractAutoProxyCreator<ul>
<li>AbstractAutoProxyCreator extends ProxyProcessorSupport implements SmartInstantiationAwareBeanPostProcessor, BeanFactoryAware</li>
<li>关注后置处理器(在bean初始化完成前后做的事情)；自动装配BeanFactoryAware</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>还是从测试类开始走断点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sicmatr1x.aop.MathCalculator;<br><span class="hljs-keyword">import</span> com.sicmatr1x.config.MainConfigOfAOP;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOCTest_AOP</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">// 创建IOC容器</span><br>        <span class="hljs-type">AnnotationConfigApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(MainConfigOfAOP.class); <span class="hljs-comment">// &lt;========= 传入配置类，创建IOC容器</span><br>        <span class="hljs-comment">// 从Spring容器中的对象才有AOP功能</span><br>        <span class="hljs-type">MathCalculator</span> <span class="hljs-variable">mathCalculator</span> <span class="hljs-operator">=</span> applicationContext.getBean(MathCalculator.class);<br>        mathCalculator.div(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br><br>        applicationContext.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationConfigApplicationContext</span><span class="hljs-params">(Class&lt;?&gt;... annotatedClasses)</span> &#123;<br>	<span class="hljs-built_in">this</span>();<br>	register(annotatedClasses);<br>	refresh(); <span class="hljs-comment">// &lt;========= 调用refresh()刷新容器</span><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// Register bean processors that intercept bean creation.</span><br>registerBeanPostProcessors(beanFactory); <span class="hljs-comment">// &lt;========= 注册bean的后置处理器来方便拦截bean的创建</span><br></code></pre></td></tr></table></figure>

<ol>
<li>传入配置类，创建IOC容器</li>
<li>调用<code>refresh()</code>刷新容器</li>
<li><code>registerBeanPostProcessors(beanFactory)</code>注册bean的后置处理器来方便拦截bean的创建</li>
<li>先获取IOC容器已经定义了的需要创建对象的所有的BeanPostProcessor</li>
<li>给容器中加别的BeanPostProcessor</li>
<li>优先注册实现了PriorityOrdered接口的BeanPostProcessor</li>
<li>再给容器中注册实现了Ordered接口的BeanPostProcessor</li>
<li>注册没实现优先级接口的BeanPostProcessor</li>
<li>注册BeanPostProcessor，实际上就是创建BeanPostProcessor对象，并保存到容器中：创建internalAutoProxyCreator的BeanPostProcessor<br>1. 创建Bean的实例<br>2. populateBean：给bean的各种属性赋值<br>3. initializeBean：初始化bean：<ol>
<li>invokeAwareMethods()：处理各种Aware接口的方法回调</li>
<li>applyBeanPostProcessorsBeforeInitialization()：应用后置处理器的postProcessorsBeforeInitialization()方法</li>
<li>invokeInitMethods()：执行自定义的初始化方法</li>
<li>applyBeanPostProcessorsAfterInitialization()：执行后置处理器的postProcessorsAfterInitialization()方法<ol start="4">
<li>BeanPostProcessor(AnnotationAwareAspectJAutoProxyCreator)创建成功</li>
</ol>
</li>
</ol>
</li>
</ol>
<hr>
<h2 id="扩展原理"><a href="#扩展原理" class="headerlink" title="扩展原理"></a>扩展原理</h2><!-- TODO: -->

<h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><!-- TODO: -->
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2020/06/08/Buffer/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8frp%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E6%9D%A5%E8%AE%BF%E9%97%AE%E5%B1%80%E5%9F%9F%E7%BD%91web%E6%9C%8D%E5%8A%A1%E7%9A%84/">← Next 我是如何使用frp内网穿透来访问局域网web服务的</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2020/04/10/Network/Nginx/">Nginx Prev →</a></div></div></div><div id="comments"><div class="selector"><button class="gitalk-sel"></button></div><div id="gitalk"></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="回到顶部" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="文章目录">≡</a><a id="color-mode" onClick="colorMode.change()" title="切换主题"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Sicmatr1x</a></h1><div id="description"><p>INTP/Traveller/Stoicism/Crypto-anarchism/Minimalism/Cosmopolitanism/English learner/Crypto/Java Engineer</p></div></div><div id="aside-block"><div id="toc-div"><h1>目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8"><span class="toc-number">1.</span> <span class="toc-text">容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E6%B3%A8%E5%86%8C"><span class="toc-number">1.1.</span> <span class="toc-text">组件注册</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Configuration-amp-Bean-%E7%BB%99%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%B3%A8%E5%86%8C%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.1.</span> <span class="toc-text">@Configuration &amp; @Bean 给容器中注册组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ComponentScan-%E8%87%AA%E5%8A%A8%E6%89%AB%E6%8F%8F%E7%BB%84%E4%BB%B6-amp-%E6%8C%87%E5%AE%9A%E6%89%AB%E6%8F%8F%E8%A7%84%E5%88%99"><span class="toc-number">1.1.2.</span> <span class="toc-text">@ComponentScan 自动扫描组件&amp;指定扫描规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89TypeFilter%E6%8C%87%E5%AE%9A%E8%BF%87%E6%BB%A4%E8%A7%84%E5%88%99"><span class="toc-number">1.1.3.</span> <span class="toc-text">自定义TypeFilter指定过滤规则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Scope-%E8%AE%BE%E7%BD%AE%E7%BB%84%E4%BB%B6%E4%BD%9C%E7%94%A8%E5%9F%9F"><span class="toc-number">1.1.4.</span> <span class="toc-text">@Scope 设置组件作用域</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Lazy-bean-%E6%87%92%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.1.5.</span> <span class="toc-text">@Lazy-bean 懒加载</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Conditional-%E6%8C%89%E7%85%A7%E6%9D%A1%E4%BB%B6%E6%B3%A8%E5%86%8Cbean"><span class="toc-number">1.1.6.</span> <span class="toc-text">@Conditional 按照条件注册bean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%B3%A8%E5%86%8C%E7%BB%84%E4%BB%B6%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.7.</span> <span class="toc-text">容器中注册组件方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Import-%E7%BB%99%E5%AE%B9%E5%99%A8%E4%B8%AD%E5%BF%AB%E9%80%9F%E5%AF%BC%E5%85%A5%E4%B8%80%E4%B8%AA%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.8.</span> <span class="toc-text">@Import 给容器中快速导入一个组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Import-%E4%BD%BF%E7%94%A8ImportSelector"><span class="toc-number">1.1.9.</span> <span class="toc-text">@Import 使用ImportSelector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Import-%E4%BD%BF%E7%94%A8ImportBeanDefinitionRegistrar"><span class="toc-number">1.1.10.</span> <span class="toc-text">@Import 使用ImportBeanDefinitionRegistrar</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8FactoryBean%E6%B3%A8%E5%86%8C%E7%BB%84%E4%BB%B6"><span class="toc-number">1.1.11.</span> <span class="toc-text">使用FactoryBean注册组件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">1.2.</span> <span class="toc-text">生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Bean%E6%8C%87%E5%AE%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E9%94%80%E6%AF%81%E6%96%B9%E6%B3%95"><span class="toc-number">1.2.1.</span> <span class="toc-text">@Bean指定初始化和销毁方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#InitializingBean-amp-DisposableBean"><span class="toc-number">1.2.2.</span> <span class="toc-text">InitializingBean &amp; DisposableBean</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PostConstruct-amp-PreDestroy"><span class="toc-number">1.2.3.</span> <span class="toc-text">@PostConstruct &amp; @PreDestroy</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanPostProcessor-bean%E7%9A%84%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text">BeanPostProcessor bean的后置处理器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanPostProcessor-%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.5.</span> <span class="toc-text">BeanPostProcessor 原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BeanPostProcessor%E5%9C%A8Spring%E5%BA%95%E5%B1%82%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.6.</span> <span class="toc-text">BeanPostProcessor在Spring底层的使用</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E8%B5%8B%E5%80%BC"><span class="toc-number">1.3.</span> <span class="toc-text">属性赋值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Value%E8%B5%8B%E5%80%BC"><span class="toc-number">1.3.1.</span> <span class="toc-text">@Value赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PropertySource%E5%8A%A0%E8%BD%BD%E5%A4%96%E9%83%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.2.</span> <span class="toc-text">@PropertySource加载外部配置文件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">1.4.</span> <span class="toc-text">自动装配</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Autowired-amp-Qualifier-amp-Primary"><span class="toc-number">1.4.1.</span> <span class="toc-text">@Autowired &amp; @Qualifier &amp; @Primary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Resource-amp-Inject"><span class="toc-number">1.4.2.</span> <span class="toc-text">@Resource &amp; @Inject</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E3%80%81%E6%9E%84%E9%80%A0%E5%99%A8%E4%BD%8D%E7%BD%AE%E7%9A%84%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D"><span class="toc-number">1.4.3.</span> <span class="toc-text">方法、构造器位置的自动装配</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Profile%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">1.4.4.</span> <span class="toc-text">@Profile环境搭建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AOP"><span class="toc-number">1.5.</span> <span class="toc-text">AOP</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP%E5%8A%9F%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="toc-number">1.5.1.</span> <span class="toc-text">AOP功能测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOP%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90-EnableAspectJAutoProxyCreator"><span class="toc-number">1.5.2.</span> <span class="toc-text">AOP原理解析 @EnableAspectJAutoProxyCreator</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%8E%9F%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">扩展原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-number">3.</span> <span class="toc-text">Web</span></a></li></ol></div></div><footer><nobr>构建自 <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> 使用主题 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>主题作者 <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{gitalk = new Gitalk({
 clientID: '',
 clientSecret: '',
 repo: 'blog-comments',
 owner: 'Sicmatr1x',
 admin: ['Sicmatr1x'],
 distractionFreeMode: false,
 id: 
});
if (document.querySelector("#gitalk")) gitalk.render("gitalk");code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>