<!DOCTYPE html><html lang="en" theme-mode="dark"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Node.js Unit Test Framework | Sicmatr1x</title><script>var config = {"root":"/","search":{"preload":false,"activeHolder":"Enter here","blurHolder":"Search","noResult":"Data \"$0\" not found"},"code":{"codeInfo":"$0 - $1 lines","copy":"copy","copyFinish":"copied","expand":"expand"}}</script><script src="/js/gitalk.js"></script><script src="//unpkg.com/mermaid@9.2.2/dist/mermaid.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><script>if (window.localStorage.getItem('theme-mode') === 'light') document.documentElement.setAttribute('theme-mode', 'light')
if (window.localStorage.getItem('theme-mode') === 'dark') document.documentElement.setAttribute('theme-mode', 'dark')</script><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Sicmatr1x" type="application/atom+xml">
</head><body><div class="loading" style="opacity: 0"><div class="loadingBar left"></div><div class="loadingBar right"></div></div><main><header class="closed"><nav><div class="navBtn hide"><i class="navBtnIcon"><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span><span class="navBtnIconBar"></span></i></div><div class="navItem" id="search-header"><span class="navItemTitle"><input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="Search" spellcheck="false" maxlength="50" type="text" id="search-input"></span></div><div class="navItem" id="search-holder"></div><div class="search-popup"><div id="search-result"></div></div><ol class="navContent"><li class="navItem"><a class="navBlock" href="/"><span class="navItemTitle">Home</span></a></li><li class="navItem" matchdata="categories,tags"><a class="navBlock" href="/archives/"><span class="navItemTitle">Archives</span></a></li></ol></nav></header><article><div id="post-bg"><div id="post-title"><h1>Node.js Unit Test Framework</h1><div id="post-info"><span>First Post: <div class="control"><time datetime="2019-10-28T09:13:04.000Z" id="date"> 2019-10-28</time></div></span><br><span>Last Update: <div class="control"><time datetime="2020-05-12T07:58:09.000Z" id="updated"> 2020-05-12</time></div></span></div></div><hr><div id="post-content"><p>基于Node.js的 Unit Test Framework，用到了如下几个工具：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://mochajs.org/">mocha</a>: Mocha is a feature-rich JavaScript test framework.</li>
<li><a target="_blank" rel="noopener" href="https://sinonjs.org/">sinon.js</a>: Standalone test spies, stubs and mocks for JavaScript.</li>
<li><a target="_blank" rel="noopener" href="https://www.chaijs.com/">chai.js</a>: Chai is a BDD &#x2F; TDD assertion library.</li>
<li><a target="_blank" rel="noopener" href="https://github.com/visionmedia/supertest">supertest</a>: Super-agent driven library for testing node.js HTTP servers using a fluent API.</li>
<li><a target="_blank" rel="noopener" href="https://istanbul.js.org/">istanbul.js</a>: JavaScript test coverage made simple.</li>
</ul>
<h2 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install mocha -S<br>npm install sinon -S<br>npm install chai -S<br>npm install supertest -S<br>npm install istanbul -S<br></code></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ol>
<li>在项目的根目录下创建test文件夹，如果项目是分层结构的话可以在test下创建子目录</li>
<li>添加mocha启动命令，参数为需要扫描的含有unit test文件的文件夹</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">mocha <span class="hljs-built_in">test</span>/controller <span class="hljs-built_in">test</span>/routes <span class="hljs-built_in">test</span>/common <span class="hljs-built_in">test</span>/service<br></code></pre></td></tr></table></figure>

<p>为方便起见可以将命令添加到package.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;unit-test&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;mocha test/controller test/routes test/common test/service&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h2 id="编写-Unit-Test"><a href="#编写-Unit-Test" class="headerlink" title="编写 Unit Test"></a>编写 Unit Test</h2><p>为方便查看unit test运行结果，可以采用每一个js文件对应一个Unit Test文件，每一个function对应一个组的结构来编写</p>
<h3 id="Given-When-Then的case命名法"><a href="#Given-When-Then的case命名法" class="headerlink" title="Given-When-Then的case命名法"></a>Given-When-Then的case命名法</h3><p>Definition</p>
<p>The Given-When-Then formula is a template intended to guide the writing of acceptance tests for a User Story:</p>
<ul>
<li>Given: Set of preconditions</li>
<li>When: When an event occurs, or some action is carried out</li>
<li>Then: What outcome is achieved, or a particular set of observable consequences should obtain</li>
</ul>
<p>Example：测试对象是人</p>
<ul>
<li>Given：人的上下文预设：这是一个诗人</li>
<li>When：对人的操作：把这个人放在太平盛世中</li>
<li>Then：对人产生的结果：这个人将获得富足的生活</li>
<li>则test case命名为：Given_一个人职业是诗人_When_活在太平盛世_Then_这个人生活富足</li>
</ul>
<h3 id="一个-test-case的结构"><a href="#一个-test-case的结构" class="headerlink" title="一个 test case的结构"></a>一个 test case的结构</h3><p>一个test case分为3部分：</p>
<ol>
<li>mock函数部分</li>
<li>Given步骤: 准备测试数据部分</li>
<li>When步骤：调用测试函数</li>
<li>Then步骤：断言返回结果</li>
</ol>
<h3 id="mocha中Unit-Test的结构"><a href="#mocha中Unit-Test的结构" class="headerlink" title="mocha中Unit Test的结构"></a>mocha中Unit Test的结构</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;userController&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;#findUserByPaging()&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-comment">// 准备测试数据</span><br>    ...<br>    <span class="hljs-comment">// mock or stub function if need</span><br>    <span class="hljs-keyword">let</span> sandbox;<br>    <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      sandbox = sinon.<span class="hljs-title function_">createSandbox</span>();<br>    &#125;);<br>    <span class="hljs-title function_">afterEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>      sandbox.<span class="hljs-title function_">restore</span>()<br>    &#125;);<br>    <span class="hljs-comment">// test case</span><br>    <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should return limit user list when given offset limit&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;<br>      userController.<span class="hljs-title function_">findUserByPaging</span>(searchCriteria).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;<br>        <span class="hljs-comment">// Then</span><br>        assert.<span class="hljs-title function_">equal</span>(result.<span class="hljs-property">success</span>, <span class="hljs-literal">true</span>) <span class="hljs-comment">// assert断言</span><br>        <span class="hljs-title function_">done</span>() <span class="hljs-comment">// 表示一个Test Case结束</span><br>      &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>        <span class="hljs-title function_">done</span>(err) <span class="hljs-comment">// 表示一个Test Case结束</span><br>      &#125;)<br>    &#125;)<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>若断言不通过或者运行中抛出一个异常则会显示测试失败</p>
<h3 id="Test-Case-Example"><a href="#Test-Case-Example" class="headerlink" title="Test Case Example"></a>Test Case Example</h3><p>本例中用到的方法：</p>
<ul>
<li>mocha:<ul>
<li><code>describe()</code></li>
<li><code>done()</code></li>
</ul>
</li>
<li>sinon.js<ul>
<li><code>createSandbox()</code></li>
<li><code>stub</code></li>
</ul>
</li>
<li>chai.js<ul>
<li><code>assert.equal()</code></li>
<li><code>assert.deepEqual()</code></li>
</ul>
</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;#findUserByPaging()&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> sandbox;<br>  <span class="hljs-comment">// Given</span><br>  <span class="hljs-keyword">const</span> searchResult = &#123;<br>    <span class="hljs-string">&quot;totalCount&quot;</span>: <span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;data&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;userId&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;userDomain&quot;</span>: <span class="hljs-string">&quot;TESTUSER&quot;</span>,<br>        <span class="hljs-string">&quot;userEmail&quot;</span>: <span class="hljs-string">&quot;test.user@outlook.com&quot;</span>,<br>        <span class="hljs-string">&quot;userTel&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span>,<br>        <span class="hljs-string">&quot;userTeam&quot;</span>: <span class="hljs-string">&quot;MBC&quot;</span>,<br>        <span class="hljs-string">&quot;roleId&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;roleName&quot;</span>: <span class="hljs-string">&quot;Super Admin&quot;</span><br>      &#125;<br>    ]<br>  &#125;<br>  <span class="hljs-keyword">const</span> searchCriteria = &#123;<br>    <span class="hljs-attr">userDomain</span>: <span class="hljs-string">&#x27;TESTUSER&#x27;</span>,<br>    <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-attr">limit</span>: <span class="hljs-number">10</span><br>  &#125;<br>  <span class="hljs-keyword">const</span> expectData = &#123;<br>    <span class="hljs-string">&quot;data&quot;</span>: [<br>      &#123;<br>        <span class="hljs-string">&quot;role&quot;</span>: [<br>          &#123;<br>            <span class="hljs-string">&quot;roleId&quot;</span>: <span class="hljs-number">1</span>,<br>            <span class="hljs-string">&quot;roleName&quot;</span>: <span class="hljs-string">&quot;Super Admin&quot;</span><br>          &#125;<br>        ],<br>        <span class="hljs-string">&quot;userDomain&quot;</span>: <span class="hljs-string">&quot;TESTUSER&quot;</span>,<br>        <span class="hljs-string">&quot;userEmail&quot;</span>: <span class="hljs-string">&quot;test.user@outlook.com&quot;</span>,<br>        <span class="hljs-string">&quot;userId&quot;</span>: <span class="hljs-number">1</span>,<br>        <span class="hljs-string">&quot;userTeam&quot;</span>: <span class="hljs-string">&quot;MBC&quot;</span>,<br>        <span class="hljs-string">&quot;userTel&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span><br>      &#125;<br>    ],<br>    <span class="hljs-string">&quot;limit&quot;</span>: <span class="hljs-number">10</span>,<br>    <span class="hljs-string">&quot;offset&quot;</span>: <span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;totalCount&quot;</span>: <span class="hljs-number">1</span><br>  &#125;<br>  <span class="hljs-comment">// mock function</span><br>  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    sandbox = sinon.<span class="hljs-title function_">createSandbox</span>();<br>    sandbox.<span class="hljs-title function_">stub</span>(<span class="hljs-title class_">UserRepo</span>, <span class="hljs-string">&quot;findUserByPaging&quot;</span>).<span class="hljs-title function_">withArgs</span>(sinon.<span class="hljs-property">match</span>.<span class="hljs-property">any</span>).<span class="hljs-title function_">returns</span>(searchResult)<br>  &#125;);<br>  <span class="hljs-title function_">afterEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    sandbox.<span class="hljs-title function_">restore</span>()<br>  &#125;);<br>  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should return limit user list when given offset limit&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;<br>    <span class="hljs-comment">// When</span><br>    userController.<span class="hljs-title function_">findUserByPaging</span>(searchCriteria).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> &#123;<br>      <span class="hljs-comment">// Then</span><br>      assert.<span class="hljs-title function_">equal</span>(result.<span class="hljs-property">success</span>, <span class="hljs-literal">true</span>)<br>      assert.<span class="hljs-title function_">deepEqual</span>(result.<span class="hljs-property">data</span>, expectData)<br>      <span class="hljs-title function_">done</span>()<br>    &#125;).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> &#123;<br>      <span class="hljs-title function_">done</span>(err)<br>    &#125;)<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>对应上述代码：</p>
<ul>
<li>Given部分给出了提供的数据，<code>searchCriteria</code>和<code>searchResult</code>对象</li>
<li>When部分调用了<code>findUserByPaging</code>方法</li>
<li>Then对返回结果进行了断言，判断了是否与预期结果<code>expectData</code>符合</li>
<li>本例中对<code>findUserByPaging</code>方法所调用到的<code>UserRepo</code>对象的<code>findUserByPaging</code>方法进行了打桩并使其返回了我们对其预期的返回数据<code>searchResult</code></li>
</ul>
<h4 id="mock-or-stub"><a href="#mock-or-stub" class="headerlink" title="mock or stub"></a>mock or stub</h4><p>如上述代码所示，使用到了sinon.js的<code>createSandbox</code>和<code>stub</code>方法</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://sinonjs.org/releases/v7.5.0/sandbox/">sandbox</a></li>
<li><a target="_blank" rel="noopener" href="https://sinonjs.org/releases/v7.5.0/stubs/">stub</a></li>
</ul>
<blockquote>
<p>Default sandbox: Since <a href="mailto:&#x73;&#x69;&#110;&#111;&#x6e;&#64;&#53;&#x2e;&#x30;&#x2e;&#48;">&#x73;&#x69;&#110;&#111;&#x6e;&#64;&#53;&#x2e;&#x30;&#x2e;&#48;</a>, the sinon object is a default sandbox. Unless you have a very advanced setup or need a special configuration, you probably want to just use that one.</p>
</blockquote>
<p>与直接使用<code>sinon.stub()</code>比起来使用<code>sandbox</code>要更安全，而且在部分情况下前者会出现stub不掉的情况，而后者则不会</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;test should call all subscribers, even if there are exceptions&quot;</span> : <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>    <span class="hljs-keyword">var</span> message = <span class="hljs-string">&#x27;an example message&#x27;</span>;<br>    <span class="hljs-keyword">var</span> stub = sinon.<span class="hljs-title function_">stub</span>().<span class="hljs-title function_">throws</span>();<br>    <span class="hljs-keyword">var</span> spy1 = sinon.<span class="hljs-title function_">spy</span>();<br>    <span class="hljs-keyword">var</span> spy2 = sinon.<span class="hljs-title function_">spy</span>();<br><br>    <span class="hljs-title class_">PubSub</span>.<span class="hljs-title function_">subscribe</span>(message, stub);<br>    <span class="hljs-title class_">PubSub</span>.<span class="hljs-title function_">subscribe</span>(message, spy1);<br>    <span class="hljs-title class_">PubSub</span>.<span class="hljs-title function_">subscribe</span>(message, spy2);<br><br>    <span class="hljs-title class_">PubSub</span>.<span class="hljs-title function_">publishSync</span>(message, <span class="hljs-literal">undefined</span>);<br><br>    <span class="hljs-title function_">assert</span>(spy1.<span class="hljs-property">called</span>);<br>    <span class="hljs-title function_">assert</span>(spy2.<span class="hljs-property">called</span>);<br>    <span class="hljs-title function_">assert</span>(stub.<span class="hljs-title function_">calledBefore</span>(spy1));<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Creates a new sandbox object with spies, stubs, and mocks.</span><br><span class="hljs-keyword">var</span> sandbox = sinon.<span class="hljs-title function_">createSandbox</span>();<br><span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    sandbox = sinon.<span class="hljs-title function_">createSandbox</span>();<br>    sandbox.<span class="hljs-title function_">stub</span>(<span class="hljs-title class_">UserRepo</span>, <span class="hljs-string">&quot;findUserByPaging&quot;</span>).<span class="hljs-title function_">withArgs</span>(sinon.<span class="hljs-property">match</span>.<span class="hljs-property">any</span>).<span class="hljs-title function_">returns</span>(searchResult)<br>&#125;);<br><span class="hljs-title function_">afterEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    sandbox.<span class="hljs-title function_">restore</span>()<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="使用-supertest来编写模拟HTTP请求的-Unit-Test"><a href="#使用-supertest来编写模拟HTTP请求的-Unit-Test" class="headerlink" title="使用 supertest来编写模拟HTTP请求的 Unit Test"></a>使用 supertest来编写模拟HTTP请求的 Unit Test</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;/nj_dom_notification/users/page&#x27;</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">let</span> sandbox;<br>  <span class="hljs-keyword">const</span> data = [<br>    &#123;<br>      <span class="hljs-string">&quot;userId&quot;</span>: <span class="hljs-number">1</span>,<br>      <span class="hljs-string">&quot;userDomain&quot;</span>: <span class="hljs-string">&quot;TESTUSER&quot;</span>,<br>      <span class="hljs-string">&quot;userEmail&quot;</span>: <span class="hljs-string">&quot;test.user@outlook.com&quot;</span>,<br>      <span class="hljs-string">&quot;userTel&quot;</span>: <span class="hljs-string">&quot;1234567890&quot;</span>,<br>      <span class="hljs-string">&quot;userTeam&quot;</span>: <span class="hljs-string">&quot;MBC&quot;</span>,<br>      <span class="hljs-string">&quot;role&quot;</span>: [<br>        &#123;<br>          <span class="hljs-string">&quot;roleId&quot;</span>: <span class="hljs-number">1</span>,<br>          <span class="hljs-string">&quot;roleName&quot;</span>: <span class="hljs-string">&quot;Super Admin&quot;</span><br>        &#125;<br>      ]<br>    &#125;<br>  ]<br>  <span class="hljs-title function_">beforeEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    sandbox = sinon.<span class="hljs-title function_">createSandbox</span>();<br>    sandbox.<span class="hljs-title function_">stub</span>(userController, <span class="hljs-string">&quot;findUserByPaging&quot;</span>).<span class="hljs-title function_">callsFake</span>(<span class="hljs-function">() =&gt;</span> &#123;<br>      <span class="hljs-keyword">return</span> responseHelper.<span class="hljs-title function_">responsePageSuccess</span>(data)<br>    &#125;)<br>  &#125;);<br>  <span class="hljs-title function_">afterEach</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    sandbox.<span class="hljs-title function_">restore</span>();<br>  &#125;);<br><br>  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should get user list json when call findUserByPaging&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">done</span>) =&gt;</span> &#123;<br>    <span class="hljs-title function_">request</span>(app)<br>      .<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/nj_dom_notification/users/page?userDomain=TESTUSER&amp;limit=10&amp;offset=0&#x27;</span>)<br>      .<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;Accept&#x27;</span>, <span class="hljs-string">&#x27;application/json&#x27;</span>)<br>      .<span class="hljs-title function_">expect</span>(<span class="hljs-string">&#x27;Content-Type&#x27;</span>, <span class="hljs-string">&#x27;application/json; charset=utf-8&#x27;</span>)<br>      .<span class="hljs-title function_">expect</span>(<span class="hljs-number">200</span>, done)<br>      .<span class="hljs-title function_">expect</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) &#123;<br>        assert.<span class="hljs-title function_">equal</span>(res.<span class="hljs-property">body</span>.<span class="hljs-property">success</span>, <span class="hljs-literal">true</span>);<br>      &#125;)<br>  &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>

<h4 id="使用-Istanbul-js来统计-Unit-Test的代码覆盖率"><a href="#使用-Istanbul-js来统计-Unit-Test的代码覆盖率" class="headerlink" title="使用 Istanbul.js来统计 Unit Test的代码覆盖率"></a>使用 Istanbul.js来统计 Unit Test的代码覆盖率</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;scripts&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>   <span class="hljs-attr">&quot;unit-test-cov&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;istanbul cover node_modules/mocha/bin/_mocha -- test/controller test/routes test/common test/service&quot;</span><br> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>只需要在<code>istanbul cover</code>命令后面加上mocha的命令即可</p>
<p>若有不想统计的代码可以使用<code>/* istanbul ignore next */</code>注释来忽略掉，但是istanbul不支持文件忽略，只支持函数、选择条件级别的忽略。</p>
<div id="paginator"></div></div><div id="post-footer"><div id="pages"><div class="footer-link" style="width: 50%;text-align:right;border-right:1px #fe2 solid"><a href="/2019/10/30/%E6%AF%94%E7%89%B9%E5%B8%81%E6%98%AF%E4%BB%80%E4%B9%88/">← Next 比特币是什么</a></div><div class="footer-link" style="width: 50%;right:1px;border-left:1px #fe2 solid"><a href="/2019/10/27/Docker/">Docker Prev →</a></div></div></div><div id="comments"><div class="selector"><button class="gitalk-sel"></button></div><div id="gitalk"></div></div></div><div class="bottom-btn"><div><a id="to-top" onClick="scrolls.scrolltop();" title="To Top" style="opacity: 0; display: none;">∧</a><a id="to-index" href="#toc-div" title="To Catalog">≡</a><a id="color-mode" onClick="colorMode.change()" title="Change Theme"></a></div></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/">Sicmatr1x</a></h1><div id="description"><p></p></div></div><div id="aside-block"><div id="toc-div"><h1>Catalog</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">安装与配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99-Unit-Test"><span class="toc-number">2.</span> <span class="toc-text">编写 Unit Test</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Given-When-Then%E7%9A%84case%E5%91%BD%E5%90%8D%E6%B3%95"><span class="toc-number">2.1.</span> <span class="toc-text">Given-When-Then的case命名法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA-test-case%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">2.2.</span> <span class="toc-text">一个 test case的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mocha%E4%B8%ADUnit-Test%E7%9A%84%E7%BB%93%E6%9E%84"><span class="toc-number">2.3.</span> <span class="toc-text">mocha中Unit Test的结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Test-Case-Example"><span class="toc-number">2.4.</span> <span class="toc-text">Test Case Example</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mock-or-stub"><span class="toc-number">2.4.1.</span> <span class="toc-text">mock or stub</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-supertest%E6%9D%A5%E7%BC%96%E5%86%99%E6%A8%A1%E6%8B%9FHTTP%E8%AF%B7%E6%B1%82%E7%9A%84-Unit-Test"><span class="toc-number">2.4.2.</span> <span class="toc-text">使用 supertest来编写模拟HTTP请求的 Unit Test</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Istanbul-js%E6%9D%A5%E7%BB%9F%E8%AE%A1-Unit-Test%E7%9A%84%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87"><span class="toc-number">2.4.3.</span> <span class="toc-text">使用 Istanbul.js来统计 Unit Test的代码覆盖率</span></a></li></ol></li></ol></li></ol></div></div><footer><nobr>Published with <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a></nobr><wbr><nobr> Theme <a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknights</a></nobr><wbr><nobr>by <a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/search.js"></script><script class="pjax-js">reset=_=>{gitalk = new Gitalk({
 clientID: '',
 clientSecret: '',
 repo: 'blog-comments',
 owner: 'Sicmatr1x',
 admin: ['Sicmatr1x'],
 distractionFreeMode: false,
 id: 
});
if (document.querySelector("#gitalk")) gitalk.render("gitalk");code.findCode();}</script><script src="/js/arknights.js"></script><script src="/js/pjax.js"></script><script>window.addEventListener("load",() => {pjax = new Pjax({
 cacheBust: false,
 selectors: ['title','article','#aside-block','.pjax-js'],
 switches: {'article': Pjax.switches.sideBySide},
 switchesOptions: {
   'article': {
     classNames: {
       remove: "pjax-out",
       add: "pjax-in"
     }
   }
 }
});
document.addEventListener("pjax:complete", reset);reset()})</script></body></html>